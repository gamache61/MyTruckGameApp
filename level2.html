<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's Semi - Level 2</title>
    <style>
        body { margin: 0; background: #2d613e; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; touch-action: none; height: 100vh; width: 100vw; -webkit-user-select: none; user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        #model-name { position: absolute; top: 5px; right: 10px; color: rgba(255,255,255,0.3); font-size: 10px; z-index: 20; }
        #dashboard { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; pointer-events: none; text-align: center; width: 100%; }
        #msg { font-size: 16px; color: #ffd700; text-shadow: 2px 2px #000; font-weight: bold; margin-bottom: 5px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 15px; display: inline-block; width: 94%; line-height: 1.2; box-sizing: border-box; border: 1px solid #444; transition: background 0.2s; }
        #gps-screen { position: absolute; bottom: 454px; left: 50%; transform: translateX(-50%); width: 120px; height: 30px; background: rgba(0,0,0,0.8); border: 2px solid #ffd700; border-radius: 5px; color: #ffd700; font-family: 'Courier New', monospace; font-weight: bold; font-size: 11px; z-index: 20; pointer-events: none; display: flex; align-items: center; justify-content: center; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); line-height: 1.1; padding: 2px; box-sizing: border-box; }
        #msg.success { background: rgba(0,150,0,0.9); color: white; border: 2px solid #0f0; }
        #bottom-stats { display: flex; justify-content: space-between; align-items: center; padding: 0 3%; margin-top: 5px; pointer-events: auto; }
        .stat-box { background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; border: 1px solid #444; font-family: monospace; font-size: 16px; pointer-events: none; }
        #btnBackToStart { width: 35px; height: 35px; border-radius: 50%; background: #ffd700; color: #000; font-weight: bold; font-size: 20px; border: 2px solid #000; display: flex; align-items: center; justify-content: center; pointer-events: auto; cursor: pointer; text-decoration: none; position: absolute; top: 0; left: 10px; }
        #controls { position: absolute; bottom: 15px; width: 100%; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .left-controls { display: flex; flex-direction: column; gap: 6px; align-items: flex-start; pointer-events: auto; }
        .pedal-box { display: flex; gap: 5px; }
        #steering-pad { width: 160px; height: 60px; background: transparent; border-radius: 30px; position: absolute; right: -20px; bottom: 96px; touch-action: none; pointer-events: auto; display: flex; align-items: center; justify-content: center; }
        #steering-wheel { width: 30px; height: 30px; background: #000; border: none; border-radius: 50%; box-sizing: border-box; position: relative; transition: transform 0.1s linear; box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: none; }
        .btn { width: 55px; height: 48px; background: rgba(51,51,51,0.8); border: 2px solid #555; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; user-select: none; pointer-events: auto; }
        #btnStart { background: rgba(80,0,0,0.8); border-color: #f00; height: 32px; font-weight: bold; }
        #btnStart.on { background: rgba(0,80,0,0.8); border-color: #0f0; }
        #btnView { height: 32px; font-size: 8px; background: rgba(0,100,200,0.8); }
        #btnSkip { height: 32px; font-size: 8px; background: rgba(128,0,128,0.8); border-color: #a020f0; }
        #btnSkip2 { height: 32px; font-size: 8px; background: rgba(180,60,0,0.8); border-color: #ff6600; }
        #btnSave { height: 32px; font-size: 8px; background: rgba(0,150,0,0.8); border-color: #0f0; }
        #victory-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #victory-overlay h1 { color: #ffd700; font-size: 32px; margin-bottom: 20px; text-shadow: 0 0 10px #ffd700; text-align: center; }
        .continue-btn { padding: 15px 30px; font-size: 18px; background: #ffd700; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: black; }
    </style>
</head>
<body oncontextmenu="return false;">
<div id="model-name">Model: Gemini 3 Flash</div>
<div id="dashboard">
    <div id="msg">MISSION: DELIVER LUMBER TO THE CONSTRUCTION SITE!</div>
    <div id="bottom-stats">
        <div class="stat-box" style="color:#33ccff;">TIME: <span id="timer">00:00</span></div>
        <div class="stat-box" style="color:#ff9900;">DIST: <span id="miles">0.0</span></div>
        <a href="index.html" id="btnBackToStart">?</a>
    </div>
</div>
<div id="gps-screen">TO CONST.SITE</div>
<canvas id="compassCanvas" style="position:absolute;bottom:120px;right:15px;width:90px;height:90px;z-index:20;pointer-events:none;"></canvas>
<div id="victory-overlay">
    <h1 id="victory-msg">LOADED & READY!<br>LEVEL 2 COMPLETE!</h1>
    <button class="continue-btn" onclick="startLevel3()">Head to Level 3</button>
</div>
<canvas id="gameCanvas"></canvas>
<div id="controls">
    <div class="left-controls">
        <div class="pedal-box">
            <div id="btnDown" class="btn">REV</div>
            <div id="btnUp" class="btn">GAS</div>
        </div>
        <div style="display:flex; gap:4px; margin-top:4px;">
            <button id="btnStart" class="btn">START</button>
            <button id="btnView" class="btn">VIEW</button>
            <button id="btnSave" class="btn" onclick="toggleEditMode()">EDIT</button>
            <button id="btnDrop" class="btn" style="height:32px; font-size:8px; background:rgba(200,100,0,0.8);" onclick="handleHitch()">DROP/HOOK</button>
            <button id="btnSkip" class="btn" onclick="skipToGravel()">SKIP</button>
            <button id="btnSkip2" class="btn" onclick="skipToConstructionSite()">SKIP2</button>
        </div>
    </div>
    <div id="steering-pad"><div id="steering-wheel"></div></div>
</div>
<script>
const DEV_MODE = true;

const LUMBER_4FT=46;
const LUMBER_8FT=92;
const LUMBER_PORT_W=LUMBER_4FT;
const LUMBER_PORT_H=LUMBER_8FT;
const LUMBER_LAND_W=LUMBER_8FT;
const LUMBER_LAND_H=LUMBER_4FT;

let missionPhase=0;
function setMissionPhase(p){
    missionPhase=p;
    const msg=document.getElementById("msg"),gps=document.getElementById("gps-screen");
    msg.classList.remove("success");
    if(p===0){msg.innerText="MISSION: DELIVER LUMBER TO THE CONSTRUCTION SITE!";gps.innerText="TO CONST.SITE";}
    else if(p===1){msg.innerText="UNLOADING AT CONSTRUCTION SITE...";gps.innerText="UNLOAD HERE";msg.classList.add("success");setTimeout(()=>msg.classList.remove("success"),2500);}
    else if(p===2){msg.innerText="MISSION: HEAD TO LUMBER YARD 2 FOR ANOTHER LOAD!";gps.innerText="TO LBR YRD 2";msg.classList.add("success");setTimeout(()=>msg.classList.remove("success"),3000);}
    else if(p===3){msg.innerText="LOADING AT LUMBER YARD 2...";gps.innerText="LOAD UP";}
    else if(p===4){gameActive=false;document.getElementById("victory-overlay").style.display="flex";}
}

const roadBaseY=850,siteLocationX=4000,roadWidth=254,lumberRoadLength=1200;
const ROAD_COLOR="#333",ROAD_LINE="#ffd700";
let gravelRoadX=parseFloat(localStorage.getItem('remiSemi_gravelRoadX'))||(siteLocationX-8000);
const gravelRoadLength=2000;
let gravelRoadTopOffset=parseFloat(localStorage.getItem('remiSemi_gravelRoadTopOffset'))||0;
let gravelRoadBottomOffset=parseFloat(localStorage.getItem('remiSemi_gravelRoadBottomOffset'))||0;
const FLARE_SPREAD=roadWidth*0.9,FLARE_DEPTH=roadWidth*0.55;

function drawHorizRoad(x1,x2,y){ctx.fillStyle=ROAD_COLOR;ctx.fillRect(x1,y,x2-x1,roadWidth);ctx.strokeStyle=ROAD_LINE;ctx.lineWidth=6;ctx.setLineDash([40,40]);ctx.beginPath();ctx.moveTo(x1,y+roadWidth/2);ctx.lineTo(x2,y+roadWidth/2);ctx.stroke();ctx.setLineDash([]);}
function drawVertRoad(x,y1,y2){ctx.fillStyle=ROAD_COLOR;ctx.fillRect(x-roadWidth/2,y1,roadWidth,y2-y1);ctx.strokeStyle=ROAD_LINE;ctx.lineWidth=6;ctx.setLineDash([40,40]);ctx.beginPath();ctx.moveTo(x,y1);ctx.lineTo(x,y2);ctx.stroke();ctx.setLineDash([]);}
function drawFlare(cx,jY,dd){const lx=cx-roadWidth/2,rx=cx+roadWidth/2,d=FLARE_DEPTH*dd;ctx.fillStyle=ROAD_COLOR;ctx.beginPath();ctx.moveTo(lx,jY);ctx.lineTo(lx-FLARE_SPREAD,jY);ctx.lineTo(lx,jY+d);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(rx,jY);ctx.lineTo(rx+FLARE_SPREAD,jY);ctx.lineTo(rx,jY+d);ctx.closePath();ctx.fill();}
function isOnFlare(px,py,cx,jY,dd){const lx=cx-roadWidth/2,rx=cx+roadWidth/2,d=FLARE_DEPTH*dd;return pointInTri(px,py,lx,jY,lx-FLARE_SPREAD,jY,lx,jY+d)||pointInTri(px,py,rx,jY,rx+FLARE_SPREAD,jY,rx,jY+d);}
function pointInTri(px,py,ax,ay,bx,by,cx,cy){const d1=(px-bx)*(ay-by)-(ax-bx)*(py-by),d2=(px-cx)*(by-cy)-(bx-cx)*(py-cy),d3=(px-ax)*(cy-ay)-(cx-ax)*(py-ay);return !((d1<0||d2<0||d3<0)&&(d1>0||d2>0||d3>0));}

const constructionSiteJunctionX=siteLocationX-3000,constructionRoadLength=2000,CS_W=3250,CS_H=3600;
let constructionSite={x:0,y:0,w:CS_W,h:CS_H};
function updateConstructionSitePosition(){constructionSite.x=constructionSiteJunctionX-CS_W/2;constructionSite.y=roadBaseY-constructionRoadLength-CS_H;}
updateConstructionSitePosition();

const BARM_W=650;
function getBuildingRects(){
    const sx=constructionSite.x,sy=constructionSite.y,margin=120;
    const hX=sx+margin,hY=sy+margin,hW=CS_W-margin*2,hH=BARM_W;
    const vX=sx+CS_W-margin-BARM_W,vY=sy+margin+BARM_W,vW=BARM_W,vH=CS_H-margin*2-BARM_W-400;
    return{hX,hY,hW,hH,vX,vY,vW,vH};
}
function getCsLoadingZone(){
    const lzW=180,lzH=900;
    const lzX=constructionSite.x+CS_W/2-lzW/2;
    const lzY=constructionSite.y+CS_H-lzH-800;
    return{x:lzX,y:lzY,w:lzW,h:lzH};
}

let csForklift={x:0,y:0,angle:Math.PI,state:"idle",carrying:false,path:[],pathIndex:0,speed:7,side:"right"};
let csUnloadedLifts=[];
let csLiftsUnloaded=0;

function resetCsForklift(){
    const lz=getCsLoadingZone();
    csForklift.x=lz.x+lz.w+250;
    csForklift.y=lz.y+lz.h/2;
    csForklift.angle=Math.PI;
    csForklift.state="idle";
    csForklift.carrying=false;
    csForklift.path=[];
    csForklift.pathIndex=0;
    csForklift.side="right";
}
resetCsForklift();

function planCsUnload(){
    if(csLiftsUnloaded>=12||missionPhase!==1||!activeTrailer)return;

    const unloadIndex = csLiftsUnloaded;
    let targetSide = "right";
    let rowIndex = 0;

    if(unloadIndex < 3){
        targetSide = "right";
        rowIndex = unloadIndex;
    } else if(unloadIndex < 9){
        targetSide = "left";
        rowIndex = unloadIndex - 3;
    } else {
        targetSide = "right";
        rowIndex = (unloadIndex - 9) + 3;
    }

    const frontY = activeTrailer.y - activeTrailer.w/2 + 50;
    const grabY = frontY + (rowIndex * 83);
    const grabX = targetSide === "right"
        ? activeTrailer.x + TRAILER_H/2 + 50
        : activeTrailer.x - TRAILER_H/2 - 50;

    const lz = getCsLoadingZone();
    const stackX = targetSide === "right"
        ? lz.x + lz.w + 300
        : lz.x - 300;
    const stackY = lz.y + 80 + (rowIndex * 140);

    const rearY = activeTrailer.y + activeTrailer.w/2 + 200;
    const rightLaneX = activeTrailer.x + TRAILER_H/2 + 250;
    const leftLaneX = activeTrailer.x - TRAILER_H/2 - 250;
    const homeY = activeTrailer.y;

    const currentLaneX = csForklift.side === "right" ? rightLaneX : leftLaneX;
    const targetLaneX = targetSide === "right" ? rightLaneX : leftLaneX;

    csForklift.path = [];
    csForklift.pathIndex = 0;

    if(csForklift.side !== targetSide){
        csForklift.path.push({x: currentLaneX, y: rearY, angle: Math.PI/2, action: 'move', label: "TO REAR"});
        csForklift.path.push({x: targetLaneX, y: rearY, angle: targetSide === "right" ? Math.PI : 0, action: 'move', label: "SWITCH SIDE"});
    }

    csForklift.path.push({x: grabX, y: grabY, angle: targetSide === "right" ? Math.PI : 0, action: 'grab', label: "GRAB LIFT"});
    csForklift.path.push({x: stackX, y: stackY, angle: -Math.PI/2, action: 'stack', label: "DROP STACK"});
    csForklift.path.push({x: targetLaneX, y: homeY, angle: targetSide === "right" ? Math.PI : 0, action: 'reset', label: "RETURN HOME"});

    csForklift.side = targetSide;
    csForklift.state='moving';
}

function updateCsForklift(){
    if(missionPhase===1&&activeTrailer&&Math.abs(tractor.speed)<0.1&&liftsLoaded>0&&csForklift.state==='idle'){
        const lz=getCsLoadingZone();
        const inZone=activeTrailer.x>lz.x&&activeTrailer.x<lz.x+lz.w&&activeTrailer.y>lz.y&&activeTrailer.y<lz.y+lz.h;
        if(inZone)planCsUnload();
    }
    if(csForklift.state==='moving'||csForklift.state==='carrying'){
        const tg=csForklift.path[csForklift.pathIndex];
        const dx=tg.x-csForklift.x,dy=tg.y-csForklift.y,dist=Math.sqrt(dx*dx+dy*dy);
        if(dist>5){
            csForklift.x+=(dx/dist)*csForklift.speed;
            csForklift.y+=(dy/dist)*csForklift.speed;
            let ad=tg.angle-csForklift.angle;
            while(ad>Math.PI)ad-=Math.PI*2;
            while(ad<-Math.PI)ad+=Math.PI*2;
            csForklift.angle+=ad*0.1;
        } else {
            csForklift.x=tg.x; csForklift.y=tg.y;
            if(tg.action==='grab'){liftsLoaded=Math.max(0,liftsLoaded-1);csForklift.carrying=true;csForklift.state='carrying';}
            else if(tg.action==='stack'){csUnloadedLifts.push({x:csForklift.x,y:csForklift.y});csForklift.carrying=false;csForklift.state='moving';csLiftsUnloaded++;if(csLiftsUnloaded>=12)setMissionPhase(2);}
            else if(tg.action==='reset'){csForklift.state='moving';}
            csForklift.pathIndex++;
            if(csForklift.pathIndex>=csForklift.path.length){csForklift.state='idle';if(liftsLoaded>0&&missionPhase===1)planCsUnload();}
        }
    }
}

let csMachines=[
    {type:'excavator',x:1400,y:1000,angle:0,basePath:[{x:1200,y:900},{x:1800,y:900},{x:1800,y:1200},{x:1200,y:1200}],pathIdx:0},
    {type:'bulldozer',x:600,y:1400,angle:0,basePath:[{x:400,y:1300},{x:1100,y:1300},{x:1100,y:1600},{x:400,y:1600}],pathIdx:0},
    {type:'dumpTruck',x:900,y:1800,angle:0,basePath:[{x:500,y:1800},{x:1300,y:1800}],pathIdx:0},
    {type:'crane',x:800,y:1000,angle:0}
];
function updateCsMachines(){
    csMachines.forEach(m=>{
        if(!m.basePath)return;
        const target=m.basePath[m.pathIdx];
        const wx=constructionSite.x+target.x,wy=constructionSite.y+target.y;
        const mx=constructionSite.x+m.x,my=constructionSite.y+m.y;
        const dx=wx-mx,dy=wy-my,dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<10)m.pathIdx=(m.pathIdx+1)%m.basePath.length;
        else{m.x+=(dx/dist)*1.5;m.y+=(dy/dist)*1.5;m.angle=Math.atan2(dy,dx);}
    });
}
let materialPiles=[{x:300,y:1500,type:'gravel'},{x:600,y:1500,type:'sand'},{x:900,y:1500,type:'concrete'},{x:1200,y:1500,type:'steel'}];
function isOnConstructionRoad(x,y){return Math.abs(x-constructionSiteJunctionX)<=roadWidth/2&&y<=roadBaseY&&y>=roadBaseY-constructionRoadLength;}

const remoteLumberYard={x:siteLocationX-1625,y:roadBaseY+roadWidth+lumberRoadLength,w:3250,h:3600};
const loadingZone={x:remoteLumberYard.x+remoteLumberYard.w/2-roadWidth/2,y:remoteLumberYard.y+550,w:roadWidth,h:800};

let startYardH=1500,startYardW=3250,startYardX,startYardY,startYard,startYardLZone;
function updateStartYardPositions(){
    startYardX=gravelRoadX-startYardW/2;startYardY=roadBaseY-gravelRoadLength-startYardH;
    startYard={x:startYardX,y:startYardY,w:startYardW,h:startYardH};
    startYardLZone={x:startYard.x+startYard.w/2-roadWidth/2,y:startYard.y+startYard.h/2-400,w:roadWidth,h:800};
}
updateStartYardPositions();

let gravelRoadHandles={center:{x:0,y:0},top:{x:0,y:0},bottom:{x:0,y:0}};
function updateGravelRoadHandles(){
    const yb=startYard.y+startYard.h,mt=roadBaseY;
    gravelRoadHandles.center={x:gravelRoadX,y:(yb+mt)/2};
    gravelRoadHandles.top={x:gravelRoadX+gravelRoadTopOffset,y:yb+200};
    gravelRoadHandles.bottom={x:gravelRoadX+gravelRoadBottomOffset,y:mt-200};
}
updateGravelRoadHandles();

function drawCurvedGravelRoad(ctx){
    const yb=startYard.y+startYard.h,mt=roadBaseY;
    const cp1X=gravelRoadX+gravelRoadTopOffset,cp1Y=yb+(mt-yb)*0.33;
    const cp2X=gravelRoadX+gravelRoadBottomOffset,cp2Y=yb+(mt-yb)*0.67;
    ctx.fillStyle=ROAD_COLOR;
    for(let t=0;t<1;t+=0.01){
        const a=1-t,b=1-(t+0.01);
        const x1=a*a*a*gravelRoadX+3*a*a*t*cp1X+3*a*t*t*cp2X+t*t*t*gravelRoadX;
        const y1=a*a*a*yb+3*a*a*t*cp1Y+3*a*t*t*cp2Y+t*t*t*mt;
        const x2=b*b*b*gravelRoadX+3*b*b*(t+0.01)*cp1X+3*b*(t+0.01)*(t+0.01)*cp2X+(t+0.01)*(t+0.01)*(t+0.01)*gravelRoadX;
        const y2=b*b*b*yb+3*b*b*(t+0.01)*cp1Y+3*b*(t+0.01)*(t+0.01)*cp2Y+(t+0.01)*(t+0.01)*(t+0.01)*mt;
        const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy)||1;
        const px=-dy/len*roadWidth/2,py=dx/len*roadWidth/2;
        ctx.beginPath();ctx.moveTo(x1+px,y1+py);ctx.lineTo(x1-px,y1-py);ctx.lineTo(x2-px,y2-py);ctx.lineTo(x2+px,y2+py);ctx.closePath();ctx.fill();
    }
    ctx.strokeStyle=ROAD_LINE;ctx.lineWidth=6;ctx.setLineDash([40,40]);
    ctx.beginPath();
    for(let t=0;t<=1;t+=0.01){const a=1-t;const cx=a*a*a*gravelRoadX+3*a*a*t*cp1X+3*a*t*t*cp2X+t*t*t*gravelRoadX;const cy=a*a*a*yb+3*a*a*t*cp1Y+3*a*t*t*cp2Y+t*t*t*mt;if(t===0)ctx.moveTo(cx,cy);else ctx.lineTo(cx,cy);}
    ctx.stroke();ctx.setLineDash([]);
    drawFlare(gravelRoadX,startYard.y+startYard.h,+1);
}
function isOnCurvedGravelRoad(x,y){
    const yb=startYard.y+startYard.h,mt=roadBaseY;
    const cp1X=gravelRoadX+gravelRoadTopOffset,cp1Y=yb+(mt-yb)*0.33;
    const cp2X=gravelRoadX+gravelRoadBottomOffset,cp2Y=yb+(mt-yb)*0.67;
    for(let t=0;t<=1;t+=0.02){const a=1-t;const cx=a*a*a*gravelRoadX+3*a*a*t*cp1X+3*a*t*t*cp2X+t*t*t*gravelRoadX;const cy=a*a*a*yb+3*a*a*t*cp1Y+3*a*t*t*cp2Y+t*t*t*mt;if(Math.sqrt((x-cx)**2+(y-cy)**2)<roadWidth/2)return true;}
    if(isOnFlare(x,y,gravelRoadX,startYard.y+startYard.h,+1))return true;
    if(isOnFlare(x,y,roadBaseY,-1))return true;
    return false;
}

let startYardStacks=[];
function rebuildStartYardStacks(){
    startYardStacks=[];let lc=0,rc=0;
    for(let i=0;i<12;i++)for(let j=0;j<2;j++){
        startYardStacks.push({x:startYardLZone.x-210-(j+1)*100,y:startYardLZone.y-220+i*70,exists:lc>=6});if(lc<6)lc++;
        startYardStacks.push({x:startYardLZone.x+startYardLZone.w+110+(j+1)*100,y:startYardLZone.y-220+i*70,exists:rc>=6});if(rc<6)rc++;
    }
}
rebuildStartYardStacks();
let startYardCars=[];
function rebuildStartYardCars(){startYardCars=[];for(let i=0;i<6;i++)startYardCars.push({x:startYard.x+100+(i*80),y:startYard.y+150,color:['#c0c0c0','#444','#fff','#003366','#800000'][i%5]});}
rebuildStartYardCars();

let isEditMode=false,activeEditTarget=null;
const keys={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false};
const SPAWN_ANGLE=Math.PI/2;
let SPAWN_X,SPAWN_Y;
function updateSpawnPosition(){SPAWN_X=startYardLZone.x+startYardLZone.w/2;SPAWN_Y=startYardLZone.y+startYardLZone.h-200;}
updateSpawnPosition();

function skipToGravel(){
    tractor.x=siteLocationX;tractor.y=roadBaseY+roadWidth+50;tractor.angle=Math.PI/2;tractor.speed=0;
    if(activeTrailer){activeTrailer.angle=tractor.angle;activeTrailer.x=tractor.x-Math.cos(tractor.angle)*440;activeTrailer.y=tractor.y-Math.sin(tractor.angle)*440;}
}
function skipToConstructionSite(){
    const lz=getCsLoadingZone();
    tractor.x=lz.x+lz.w/2;tractor.y=lz.y+lz.h-200;tractor.angle=-Math.PI/2;tractor.speed=0;
    if(activeTrailer){activeTrailer.angle=tractor.angle;activeTrailer.x=tractor.x-Math.cos(tractor.angle)*440;activeTrailer.y=tractor.y-Math.sin(tractor.angle)*440;}
}
function toggleEditMode(){
    const btn=document.getElementById("btnSave"),msg=document.getElementById("msg");
    if(!isEditMode){isEditMode=true;btn.innerText="SAVE";btn.style.background="rgba(200,0,0,0.8)";msg.innerText="EDIT MODE: DRAG HANDLES TO ADJUST ROADS";}
    else{isEditMode=false;btn.innerText="EDIT";btn.style.background="rgba(0,150,0,0.8)";localStorage.setItem('remiSemi_gravelRoadX',gravelRoadX);localStorage.setItem('remiSemi_gravelRoadTopOffset',gravelRoadTopOffset);localStorage.setItem('remiSemi_gravelRoadBottomOffset',gravelRoadBottomOffset);localStorage.setItem('remiSemi_trees',JSON.stringify(trees));msg.innerText="LAYOUT SAVED!";setTimeout(()=>{msg.innerText="MISSION: DELIVER LUMBER TO THE CONSTRUCTION SITE!";},2000);}
}

let timeElapsed=0,gameActive=true,timerStarted=false,liftsLoaded=12,truckDamage=0;

let lumberStacks=[];
for(let side=0;side<2;side++){
    let bx=side===0?-750:450;
    for(let block=0;block<3;block++){
        let by=block*450;
        for(let row=0;row<3;row++)for(let col=0;col<4;col++)
            lumberStacks.push({
                x:loadingZone.x+bx+(col*(LUMBER_LAND_W+20)),
                y:loadingZone.y+100+by+(row*(LUMBER_LAND_H+10))-200,
                w:LUMBER_LAND_W,h:LUMBER_LAND_H,exists:true
            });
    }
}

let forklift={x:loadingZone.x+loadingZone.w+150,y:loadingZone.y+400,angle:Math.PI,state:"idle",carrying:false,path:[],pathIndex:0,speed:7,side:"right",targetStack:null};

const savedTrees=localStorage.getItem('remiSemi_trees');
let trees=savedTrees?JSON.parse(savedTrees):[];
if(trees.length===0){for(let i=0;i<100;i++){let tx=(Math.random()-0.5)*15000+2000,ty=(Math.random()-0.5)*10000+1000;if(Math.sqrt((tx-loadingZone.x)**2+(ty-loadingZone.y)**2)>1000)trees.push({x:tx,y:ty,size:40+Math.random()*30,rotation:Math.random()*Math.PI*2});}}

const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");
const compassCanvas=document.getElementById("compassCanvas"),cctx=compassCanvas.getContext("2d");
const padEl=document.getElementById("steering-pad"),wheelEl=document.getElementById("steering-wheel"),startBtn=document.getElementById("btnStart");
let engineOn=false;
const touch={up:false,down:false};
let currentZoom=0.35;

const tractor={x:SPAWN_X,y:SPAWN_Y,w:292.5,h:67.5,angle:SPAWN_ANGLE,speed:0,accel:0.05,revAccel:0.04,friction:0.98,steerAngle:0};
const camera={x:0,y:0};
const TRAILER_W=550,TRAILER_H=92;
let hitchX=SPAWN_X-Math.cos(SPAWN_ANGLE)*101.25,hitchY=SPAWN_Y-Math.sin(SPAWN_ANGLE)*101.25;
let trailerCX=hitchX-Math.cos(SPAWN_ANGLE)*(TRAILER_W/2-33.75),trailerCY=hitchY-Math.sin(SPAWN_ANGLE)*(TRAILER_W/2-33.75);
let allTrailers=[{x:trailerCX,y:trailerCY,w:TRAILER_W,h:TRAILER_H,angle:SPAWN_ANGLE,type:'flatbed'}];
let activeTrailer=allTrailers[0],isSteeringActive=false;

let startForkliftX,startForkliftY;
const startForkliftAngle=Math.PI,startForkliftCarrying=false;
function updateStartForkliftPosition(){startForkliftX=startYardLZone.x+startYardLZone.w+200;startForkliftY=startYardLZone.y+400;}
updateStartForkliftPosition();

const timerInterval=setInterval(()=>{if(!gameActive||!timerStarted)return;timeElapsed++;const m=Math.floor(timeElapsed/60),s=timeElapsed%60;document.getElementById("timer").innerText=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;},1000);

function handleHitch(){if(activeTrailer)activeTrailer=null;else allTrailers.forEach(t=>{if(Math.sqrt((tractor.x-t.x)**2+(tractor.y-t.y)**2)<300)activeTrailer=t;});}
function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;compassCanvas.width=90;compassCanvas.height=90;}
window.addEventListener('resize',resize);resize();
function screenToWorld(sx,sy){let x=sx-canvas.width/2,y=sy-canvas.height/2;x/=currentZoom;y/=currentZoom;const a=tractor.angle+Math.PI/2,c=Math.cos(a),s=Math.sin(a);return{x:x*c-y*s+camera.x,y:x*s+y*c+camera.y};}

function drawCompass(){
    const w=90,h=90,cx=45,cy=45,r=30;
    cctx.clearRect(0,0,w,h);
    cctx.fillStyle="rgba(0,0,0,0.6)";cctx.beginPath();cctx.arc(cx,cy,42,0,Math.PI*2);cctx.fill();
    cctx.strokeStyle="#ffd700";cctx.lineWidth=2;cctx.beginPath();cctx.arc(cx,cy,42,0,Math.PI*2);cctx.stroke();
    const camRot=-(tractor.angle+Math.PI/2);
    [{label:"T",worldAngle:-Math.PI/2,color:"#ffffff"},{label:"B",worldAngle:Math.PI/2,color:"#aaaaaa"},{label:"L",worldAngle:Math.PI,color:"#88ccff"},{label:"R",worldAngle:0,color:"#88ccff"}]
    .forEach(({label,worldAngle,color})=>{
        const sa=worldAngle+camRot;const lx=cx+Math.cos(sa)*r,ly=cy+Math.sin(sa)*r;
        cctx.fillStyle=color;cctx.font="bold 16px Arial";cctx.textAlign="center";cctx.textBaseline="middle";cctx.fillText(label,lx,ly);
    });
    cctx.fillStyle="#ffd700";cctx.beginPath();cctx.arc(cx,cy,4,0,Math.PI*2);cctx.fill();
    cctx.strokeStyle="rgba(255,255,255,0.3)";cctx.lineWidth=1;
    for(let i=0;i<8;i++){const a=i*Math.PI/4;cctx.beginPath();cctx.moveTo(cx+Math.cos(a)*36,cy+Math.sin(a)*36);cctx.lineTo(cx+Math.cos(a)*42,cy+Math.sin(a)*42);cctx.stroke();}
}

function drawTree(t){ctx.save();ctx.translate(t.x,t.y);ctx.rotate(t.rotation);ctx.fillStyle="#1b4d2c";ctx.beginPath();ctx.arc(0,0,t.size,0,Math.PI*2);ctx.fill();ctx.restore();}
function drawLumberLift(x,y,w,h){
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle="#e3c5a8";
    ctx.fillRect(0,0,w,h);
    ctx.strokeStyle="#8b4513";
    ctx.lineWidth=2;
    ctx.strokeRect(0,0,w,h);
    ctx.save();
    ctx.clip();
    if(h>=w){for(let i=4;i<w;i+=6){ctx.fillStyle="rgba(0,0,0,0.07)";ctx.fillRect(i,0,2,h);}}
    else{for(let i=4;i<h;i+=6){ctx.fillStyle="rgba(0,0,0,0.07)";ctx.fillRect(0,i,w,2);}}
    ctx.restore();

    const strapColor="#2b2b2b";
    const strapWidth=Math.max(3,Math.min(6,Math.floor(Math.min(w,h)*0.12)));
    ctx.fillStyle=strapColor;
    if(w>h){
        const s1=w*0.2, s2=w*0.8;
        ctx.fillRect(s1-strapWidth/2,0,strapWidth,h);
        ctx.fillRect(s2-strapWidth/2,0,strapWidth,h);
    } else {
        const s1=h*0.2, s2=h*0.8;
        ctx.fillRect(0,s1-strapWidth/2,w,strapWidth);
        ctx.fillRect(0,s2-strapWidth/2,w,strapWidth);
    }

    ctx.fillStyle="rgba(80,40,10,0.5)";
    if(h>=w){ctx.fillRect(0,0,w,4);ctx.fillRect(0,h-4,w,4);}
    else{ctx.fillRect(0,0,4,h);ctx.fillRect(w-4,0,4,h);}
    ctx.restore();
}
function drawOfficeSimple(x,y){ctx.save();ctx.translate(x,y);ctx.fillStyle="rgba(0,0,0,0.3)";ctx.fillRect(-5,-5,410,210);ctx.fillStyle="#546e7a";ctx.fillRect(0,0,400,200);ctx.strokeStyle="#263238";ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(0,100);ctx.lineTo(400,100);ctx.stroke();ctx.fillStyle="rgba(0,0,0,0.1)";ctx.fillRect(0,100,400,100);ctx.fillStyle="#333";ctx.fillRect(320,40,30,30);ctx.restore();}
function drawCar(x,y,color,angle=0){ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.fillStyle="rgba(0,0,0,0.2)";ctx.fillRect(-32,-19,64,38);ctx.fillStyle=color;ctx.fillRect(-30,-17.5,60,35);ctx.fillStyle="#333";ctx.fillRect(5,-14,15,28);ctx.fillStyle="#fff";ctx.fillRect(26,-15,4,8);ctx.fillRect(26,7,4,8);ctx.fillStyle="#111";ctx.fillRect(-20,-19.5,12,4);ctx.fillRect(10,-19.5,12,4);ctx.fillRect(-20,15.5,12,4);ctx.fillRect(10,15.5,12,4);ctx.restore();}
function drawForkliftSprite(x,y,angle,carrying){ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.fillStyle="#e67e22";ctx.fillRect(-40,-25,80,50);ctx.fillStyle="#333";ctx.fillRect(40,-22,10,44);ctx.fillRect(50,-20,40,5);ctx.fillRect(50,15,40,5);if(carrying){drawLumberLift(50,-LUMBER_PORT_W/2,LUMBER_PORT_H,LUMBER_PORT_W);}ctx.fillStyle="#111";ctx.fillRect(-35,-28,20,8);ctx.fillRect(-35,20,20,8);ctx.fillRect(25,-28,15,8);ctx.fillRect(25,20,15,8);ctx.restore();}
function drawForkliftL1(x,y,angle,carrying){ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.fillStyle="#e67e22";ctx.fillRect(-30,-20,60,40);ctx.fillStyle="#333";ctx.fillRect(-35,-20,15,40);ctx.fillStyle="#222";ctx.fillRect(30,-18,5,36);ctx.fillStyle="#777";ctx.fillRect(35,-15,45,4);ctx.fillRect(35,11,45,4);ctx.fillStyle="#000";ctx.fillRect(10,-23,15,6);ctx.fillRect(10,17,15,6);ctx.fillRect(-25,-23,12,6);ctx.fillRect(-25,17,12,6);if(carrying){drawLumberLift(35,-LUMBER_PORT_W/2,LUMBER_PORT_H,LUMBER_PORT_W);}ctx.restore();}
function drawRealisticOffice(x,y,w,h){ctx.save();ctx.translate(x,y);ctx.rotate(Math.PI);const g=ctx.createLinearGradient(-w/2,-h/2,w/2,-h/2);g.addColorStop(0,"#444");g.addColorStop(0.5,"#666");g.addColorStop(1,"#444");ctx.fillStyle=g;ctx.fillRect(-w/2,-h/2,w,h);ctx.strokeStyle="rgba(255,255,255,0.08)";ctx.lineWidth=2;for(let i=-w/2;i<w/2;i+=15){ctx.beginPath();ctx.moveTo(i,-h/2);ctx.lineTo(i,h/2);ctx.stroke();}ctx.fillStyle="rgba(0,0,0,0.3)";ctx.fillRect(-w/2+50,-h/2+50,w-100,h-100);ctx.fillStyle="#ffcc00";ctx.font="bold 40px Arial";ctx.textAlign="center";ctx.fillText("YARD OFFICE",0,15);ctx.restore();}
function drawExcavator(x,y,angle){ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.fillStyle="#FFD700";ctx.fillRect(-40,-30,80,60);ctx.fillStyle="#333";ctx.fillRect(-50,-35,15,70);ctx.fillRect(35,-35,15,70);ctx.fillStyle="#888";ctx.fillRect(-25,-50,10,30);ctx.fillStyle="#555";ctx.fillRect(-30,-55,20,10);ctx.restore();}
function drawBulldozer(x,y,angle){ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.fillStyle="#FFA500";ctx.fillRect(-50,-25,100,50);ctx.fillStyle="#222";ctx.fillRect(50,-35,15,70);ctx.fillStyle="#333";ctx.fillRect(-60,-30,12,60);ctx.fillRect(48,-30,12,60);ctx.restore();}
function drawCrane(x,y){ctx.save();ctx.translate(x,y);ctx.fillStyle="#FFD700";ctx.fillRect(-20,-20,40,40);ctx.fillStyle="#888";ctx.fillRect(-5,-120,10,100);ctx.fillStyle="#666";ctx.fillRect(-5,-120,80,8);ctx.fillStyle="#444";ctx.fillRect(70,-120,3,40);ctx.restore();}
function drawDumpTruck(x,y,angle){ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.fillStyle="#FF6600";ctx.fillRect(-50,-30,100,60);ctx.fillStyle="#333";ctx.fillRect(40,-25,20,50);ctx.fillStyle="#111";ctx.fillRect(-55,-35,15,15);ctx.fillRect(-55,20,15,15);ctx.fillRect(40,-35,15,15);ctx.fillRect(40,20,15,15);ctx.restore();}
function drawMaterialPile(x,y,type){ctx.save();ctx.translate(x,y);const c={gravel:"#8B7355",sand:"#F4A460",concrete:"#A9A9A9",steel:"#708090"};ctx.fillStyle=c[type]||"#888";ctx.beginPath();ctx.moveTo(0,-40);ctx.lineTo(-60,20);ctx.lineTo(60,20);ctx.closePath();ctx.fill();ctx.restore();}
function drawApartmentBuilding(){
    const{hX,hY,hW,hH,vX,vY,vW,vH}=getBuildingRects();
    const BEAM="#8B7355",CONC="#A0A0A0",SLAB="#B8B8B8",WALL="rgba(180,180,195,0.75)",SCAF="#888",GLASS="rgba(150,200,255,0.45)";
    const floors=4;
    function drawArm(ax,ay,aw,ah,cols,rows){const fh=ah/rows;for(let f=0;f<rows;f++){const fy=ay+f*fh;ctx.fillStyle=f===0?CONC:SLAB;ctx.fillRect(ax,fy,aw,10);if(f<rows-1){ctx.fillStyle=WALL;ctx.fillRect(ax,fy+10,14,fh-10);ctx.fillRect(ax+aw-14,fy+10,14,fh-10);for(let c=1;c<cols;c++)ctx.fillRect(ax+c*(aw/cols)-7,fy+10,14,fh-10);ctx.fillStyle=GLASS;for(let c=0;c<cols;c++)ctx.fillRect(ax+c*(aw/cols)+20,fy+18,aw/cols-40,fh-35);}ctx.fillStyle=BEAM;for(let c=0;c<=cols;c++)ctx.fillRect(ax+c*(aw/cols)-6,fy,12,fh);}ctx.fillStyle=CONC;ctx.fillRect(ax,ay+rows*fh,aw,10);ctx.fillStyle=SCAF;for(let i=0;i<=6;i++)ctx.fillRect(ax+i*(aw/6)-2,ay-100,4,100);for(let i=0;i<5;i++)ctx.fillRect(ax,ay-100+i*20,aw,3);}
    drawArm(hX,hY,hW,hH,7,floors);drawArm(vX,vY,vW,vH,3,floors);
    ctx.fillStyle=CONC;ctx.fillRect(vX,hY,vW,hH);
    ctx.save();ctx.translate(hX+hW/2,hY-160);ctx.fillStyle="#FFD700";ctx.strokeStyle="#000";ctx.lineWidth=3;ctx.fillRect(-220,-40,440,80);ctx.strokeRect(-220,-40,440,80);ctx.fillStyle="#000";ctx.font="bold 30px Arial";ctx.textAlign="center";ctx.fillText("PINE RIDGE APARTMENTS",0,-8);ctx.font="18px Arial";ctx.fillText("UNDER CONSTRUCTION",0,20);ctx.restore();
}
function drawConstructionSiteGround(){const cx=constructionSite.x+CS_W/2,cy=constructionSite.y+CS_H/2;ctx.save();ctx.translate(cx,cy);ctx.rotate(Math.PI);ctx.fillStyle="#6B5D4F";ctx.fillRect(-CS_W/2,-CS_H/2,CS_W,CS_H);ctx.strokeStyle="#FFD700";ctx.lineWidth=10;ctx.strokeRect(-CS_W/2,-CS_H/2,CS_W,CS_H);ctx.strokeStyle="#000";ctx.lineWidth=5;ctx.setLineDash([30,30]);ctx.strokeRect(-CS_W/2+20,-CS_H/2+20,CS_W-40,CS_H-40);ctx.setLineDash([]);ctx.fillStyle="#FFD700";ctx.font="bold 70px Arial";ctx.textAlign="center";ctx.shadowBlur=10;ctx.shadowColor="rgba(0,0,0,0.8)";ctx.fillText("CONSTRUCTION SITE",0,CS_H/2-80);ctx.shadowBlur=0;ctx.restore();}
function drawLumberYardGround(){ctx.save();ctx.translate(remoteLumberYard.x,remoteLumberYard.y);ctx.fillStyle="#555";ctx.fillRect(0,0,remoteLumberYard.w,remoteLumberYard.h);ctx.strokeStyle="#fff";ctx.lineWidth=10;ctx.strokeRect(0,0,remoteLumberYard.w,remoteLumberYard.h);ctx.strokeStyle="#ffd700";ctx.lineWidth=8;ctx.setLineDash([20,15]);ctx.strokeRect(loadingZone.x-remoteLumberYard.x-10,loadingZone.y-remoteLumberYard.y-10,loadingZone.w+20,loadingZone.h+20);ctx.setLineDash([]);ctx.save();ctx.translate(loadingZone.x-remoteLumberYard.x+loadingZone.w/2,loadingZone.y-remoteLumberYard.y+loadingZone.h/2);ctx.rotate(Math.PI);ctx.fillStyle="rgba(255,215,0,0.4)";ctx.font="bold 60px Arial";ctx.textAlign="center";ctx.fillText("LOADING",0,-15);ctx.fillText("ZONE",0,55);ctx.restore();ctx.save();ctx.translate(remoteLumberYard.w/2,150);ctx.rotate(Math.PI);ctx.fillStyle="#FFD700";ctx.font="bold 70px Arial";ctx.textAlign="center";ctx.shadowBlur=10;ctx.shadowColor="rgba(0,0,0,0.8)";ctx.fillText("LUMBER YARD 2",0,0);ctx.shadowBlur=0;ctx.restore();ctx.restore();}
function drawStartYardGround(){ctx.fillStyle="#555";ctx.fillRect(startYard.x,startYard.y,startYard.w,startYard.h);ctx.strokeStyle="#fff";ctx.lineWidth=10;ctx.strokeRect(startYard.x,startYard.y,startYard.w,startYard.h);ctx.save();ctx.translate(startYard.x+startYard.w/2,startYard.y+120);ctx.rotate(Math.PI);ctx.fillStyle="#FFD700";ctx.font="bold 70px Arial";ctx.textAlign="center";ctx.shadowBlur=10;ctx.shadowColor="rgba(0,0,0,0.8)";ctx.fillText("LUMBER YARD",0,0);ctx.shadowBlur=0;ctx.restore();}
function drawConstructionSign(x,y){ctx.save();ctx.translate(x,y);ctx.fillStyle="#444";ctx.fillRect(-5,0,10,80);ctx.fillStyle="#ff8800";ctx.strokeStyle="white";ctx.lineWidth=4;ctx.fillRect(-100,-60,200,80);ctx.strokeRect(-100,-60,200,80);ctx.fillStyle="black";ctx.font="bold 18px Arial";ctx.textAlign="center";ctx.fillText("CONSTRUCTION",0,-30);ctx.fillText("SITE",0,-5);ctx.restore();}
function drawEditHandle(x,y,label,color="#00ffff",size=40){ctx.fillStyle=color;ctx.strokeStyle="#ffffff";ctx.lineWidth=5;ctx.beginPath();ctx.arc(x,y,size,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.strokeStyle="#000000";ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(x-size*0.6,y);ctx.lineTo(x+size*0.6,y);ctx.moveTo(x,y-size*0.6);ctx.lineTo(x,y+size*0.6);ctx.stroke();if(label){ctx.fillStyle="#000000";ctx.font="bold 24px Arial";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(label,x,y);}}
function drawTrailerStatic(x,y,angle,type){
    const th=TRAILER_H,tw=TRAILER_W;
    ctx.save();ctx.translate(x,y);ctx.rotate(angle);
    ctx.fillStyle="rgba(0,0,0,0.5)";ctx.fillRect(-tw/2+5,-th/2+5,tw,th);
    for(let i=-th/2;i<th/2;i+=8){ctx.fillStyle=(Math.floor(i/8)%2===0)?"#5d4037":"#4a352f";ctx.fillRect(-tw/2,i,tw,8);}
    ctx.fillStyle="#b0b0b0";ctx.fillRect(-tw/2,-th/2,tw,6);ctx.fillRect(-tw/2,th/2-6,tw,6);
    for(let i=-tw/2;i<tw/2;i+=20){ctx.fillStyle=(Math.floor(i/20)%2===0)?"#d32f2f":"#ffffff";ctx.fillRect(i,-th/2+1,10,2);ctx.fillRect(i,th/2-3,10,2);}
    if(liftsLoaded>0){
        const cols=2,rows=6,rowSpacing=(tw-20)/rows;
        let count=0;
        outer:for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){if(count>=liftsLoaded)break outer;drawLumberLift(-tw/2+10+r*rowSpacing,-th/2+c*LUMBER_PORT_W,LUMBER_PORT_H,LUMBER_PORT_W);count++;}}
    }
    ctx.strokeStyle="#ffd700";ctx.lineWidth=3;
    for(let i=-tw/2+55;i<tw/2-50;i+=80){ctx.beginPath();ctx.moveTo(i,th/2-6);ctx.lineTo(i,-th/2+6);ctx.stroke();}
    ctx.fillStyle="#000";ctx.fillRect(-tw/2+40,-th/2-5,60,10);ctx.fillRect(-tw/2+40,th/2-5,60,10);
    ctx.fillStyle="#333";ctx.fillRect(-tw/2,-th/2,5,th);
    ctx.restore();
}
function drawTruckDetailed(x,y,angle,isSteering=false,cabColor="#800000"){
    ctx.save();ctx.translate(x,y);ctx.rotate(angle);const s=2.25;
    ctx.fillStyle="#111";ctx.fillRect((-130*s)/2,(-30*s)/6,(130*s)-(50*s),(30*s)/3);ctx.fillRect(0,(-30*s)/2,60*s,30*s);
    ctx.fillStyle="#000";ctx.fillRect(-62*s,-12*s,12*s,6*s);ctx.fillRect(-62*s,6*s,12*s,6*s);ctx.fillRect(-45*s,-12*s,12*s,6*s);ctx.fillRect(-45*s,6*s,12*s,6*s);
    ctx.save();ctx.translate(46*s,(-30*s)/2+0.5);if(isSteering)ctx.rotate(tractor.steerAngle);ctx.fillRect(-6*s,-2.5*s,12*s,5*s);ctx.restore();
    ctx.save();ctx.translate(46*s,(30*s)/2-0.5);if(isSteering)ctx.rotate(tractor.steerAngle);ctx.fillRect(-6*s,-2.5*s,12*s,5*s);ctx.restore();
    ctx.fillStyle=cabColor;ctx.fillRect(-10*s,(-30*s)/2,40*s,30*s);ctx.fillRect(30*s,(-30*s)/2+4*s,30*s,(30*s)-8*s);
    ctx.fillStyle="#777";ctx.fillRect(-12*s,(-30*s)/2-5*s,6*s,6*s);ctx.fillRect(-12*s,(30*s)/2-1*s,6*s,6*s);
    ctx.fillStyle="#FFD700";for(let i=0;i<4;i++)ctx.fillRect(27*s,(-30*s)/2+4*s+(i*6.5*s),3*s,3*s);
    ctx.fillStyle="#aaa";ctx.fillRect(30*s,(-30*s)/2-4*s,4*s,5*s);ctx.fillRect(30*s,(30*s)/2-1*s,4*s,5*s);
    const bg=ctx.createLinearGradient(58*s,0,65*s,0);bg.addColorStop(0,"#888");bg.addColorStop(0.5,"#eee");bg.addColorStop(1,"#999");
    ctx.fillStyle=bg;ctx.fillRect(58*s,(-30*s)/2-1,5*s,30*s+2);ctx.restore();
}
function planProfessionalLoad(){
    if(!activeTrailer||liftsLoaded>=12||missionPhase!==3)return;

    const loadIndex = liftsLoaded;
    let targetSide = "right";
    let rowIndex = 0;

    if (loadIndex < 3) {
        targetSide = "right";
        rowIndex = (loadIndex % 3) + 3;
    } else if (loadIndex < 9) {
        targetSide = "left";
        rowIndex = 8 - loadIndex;
    } else {
        targetSide = "right";
        rowIndex = 11 - loadIndex;
    }

    const frontY = activeTrailer.y - activeTrailer.w / 2 + 50;
    const placeY = frontY + (rowIndex * 83);
    const placeX = targetSide === "right"
        ? activeTrailer.x + TRAILER_H / 2 + 50
        : activeTrailer.x - TRAILER_H / 2 - 50;

    const stackCenterX = loadingZone.x + loadingZone.w / 2;
    const desiredStackY = loadingZone.y + 80 + (rowIndex * 140);
    const stackCandidates = lumberStacks.filter(s => s.exists && (targetSide === "right" ? s.x > stackCenterX : s.x < stackCenterX));
    if (!stackCandidates.length) return;
    const stack = stackCandidates.reduce((best, s) => {
        if (!best) return s;
        return Math.abs(s.y - desiredStackY) < Math.abs(best.y - desiredStackY) ? s : best;
    }, null);

    const stackX = stack.x;
    const stackY = stack.y;

    const rearY = activeTrailer.y + activeTrailer.w / 2 + 200;
    const rightLaneX = activeTrailer.x + TRAILER_H / 2 + 250;
    const leftLaneX = activeTrailer.x - TRAILER_H / 2 - 250;
    const homeY = activeTrailer.y;

    const currentLaneX = forklift.side === "right" ? rightLaneX : leftLaneX;
    const targetLaneX = targetSide === "right" ? rightLaneX : leftLaneX;

    forklift.path = [];
    forklift.pathIndex = 0;
    forklift.targetStack = stack;

    if (forklift.side !== targetSide) {
        forklift.path.push({ x: currentLaneX, y: rearY, angle: Math.PI / 2, action: "move", label: "TO REAR" });
        forklift.path.push({ x: targetLaneX, y: rearY, angle: targetSide === "right" ? Math.PI : 0, action: "move", label: "SWITCH SIDE" });
    }

    forklift.path.push({ x: stackX, y: stackY, angle: -Math.PI / 2, action: "grab", label: "GRAB LIFT" });
    forklift.path.push({ x: placeX, y: placeY, angle: targetSide === "right" ? Math.PI : 0, action: "drop", label: "PLACE LIFT" });
    forklift.path.push({ x: targetLaneX, y: homeY, angle: targetSide === "right" ? Math.PI : 0, action: "reset", label: "RETURN HOME" });

    forklift.side = targetSide;
    forklift.state = "moving";
}
function updateForklift(){
    if(forklift.state==='idle'&&activeTrailer&&missionPhase===3){
        const cx=activeTrailer.x,cy=activeTrailer.y;
        if(cx>loadingZone.x&&cx<loadingZone.x+loadingZone.w&&cy>loadingZone.y&&cy<loadingZone.y+loadingZone.h&&Math.abs(tractor.speed)<0.1)planProfessionalLoad();
    }
    if(forklift.state==='moving'||forklift.state==='carrying'){
        let tg=forklift.path[forklift.pathIndex];
        let dx=tg.x-forklift.x,dy=tg.y-forklift.y,dist=Math.sqrt(dx*dx+dy*dy);
        if(dist>5){
            forklift.x+=(dx/dist)*forklift.speed;forklift.y+=(dy/dist)*forklift.speed;
            let ad=tg.angle-forklift.angle;while(ad>Math.PI)ad-=Math.PI*2;while(ad<-Math.PI)ad+=Math.PI*2;forklift.angle+=ad*0.1;
        } else {
            if(tg.action==='grab'){
                forklift.carrying=true;
                forklift.state='carrying';
                if(forklift.targetStack&&forklift.targetStack.exists){forklift.targetStack.exists=false;}
                else{let s=lumberStacks.find(s=>s.exists);if(s)s.exists=false;}
                forklift.targetStack=null;
            }
            else if(tg.action==='drop'){forklift.carrying=false;forklift.state='moving';liftsLoaded++;if(liftsLoaded>=12)setMissionPhase(4);}
            else if(tg.action==='reset'){forklift.state='moving';}
            forklift.pathIndex++;
            if(forklift.pathIndex>=forklift.path.length){forklift.state='idle';if(liftsLoaded<12)planProfessionalLoad();}
        }
    }
}
function update(){
    if(!gameActive)return;
    updateConstructionSitePosition();updateCsMachines();updateCsForklift();
    if(engineOn){if(touch.up||keys.ArrowUp)tractor.speed+=tractor.accel;if(touch.down||keys.ArrowDown)tractor.speed-=tractor.revAccel;}
    tractor.speed*=tractor.friction;
    if(!isSteeringActive){
        if(keys.ArrowLeft){tractor.steerAngle=Math.max(-0.6,tractor.steerAngle-0.03);wheelEl.style.transform=`translateX(${tractor.steerAngle*83.33}px)`;}
        else if(keys.ArrowRight){tractor.steerAngle=Math.min(0.6,tractor.steerAngle+0.03);wheelEl.style.transform=`translateX(${tractor.steerAngle*83.33}px)`;}
        else{tractor.steerAngle+=(0-tractor.steerAngle)*0.12;if(Math.abs(tractor.steerAngle)<0.001){tractor.steerAngle=0;wheelEl.style.transform=`translateX(0px)`;}else wheelEl.style.transform=`translateX(${tractor.steerAngle*83.33}px)`;}
    }
    document.getElementById("miles").innerText=(Math.sqrt((tractor.x-loadingZone.x)**2+(tractor.y-loadingZone.y)**2)/1000).toFixed(1);
    tractor.angle+=(tractor.speed/250)*Math.tan(tractor.steerAngle*1.2);
    tractor.x+=Math.cos(tractor.angle)*tractor.speed;tractor.y+=Math.sin(tractor.angle)*tractor.speed;
    if(missionPhase===0&&activeTrailer&&liftsLoaded>0){const lz=getCsLoadingZone();if(activeTrailer.x>lz.x&&activeTrailer.x<lz.x+lz.w&&activeTrailer.y>lz.y&&activeTrailer.y<lz.y+lz.h&&Math.abs(tractor.speed)<0.5)setMissionPhase(1);}
    if(missionPhase===2&&activeTrailer&&liftsLoaded===0){if(activeTrailer.x>loadingZone.x&&activeTrailer.x<loadingZone.x+loadingZone.w&&activeTrailer.y>loadingZone.y&&activeTrailer.y<loadingZone.y+loadingZone.h&&Math.abs(tractor.speed)<0.5)setMissionPhase(3);}
    let offRoad=true;
    if(tractor.y>=roadBaseY&&tractor.y<=roadBaseY+roadWidth)offRoad=false;
    if(tractor.x>=siteLocationX-roadWidth/2&&tractor.x<=siteLocationX+roadWidth/2&&tractor.y>=roadBaseY&&tractor.y<=roadBaseY+roadWidth+lumberRoadLength)offRoad=false;
    if(isOnFlare(tractor.x,tractor.y,siteLocationX,roadBaseY+roadWidth,+1))offRoad=false;
    if(tractor.x>=remoteLumberYard.x&&tractor.x<=remoteLumberYard.x+remoteLumberYard.w&&tractor.y>=remoteLumberYard.y&&tractor.y<=remoteLumberYard.y+remoteLumberYard.h)offRoad=false;
    if(tractor.x>=startYard.x&&tractor.x<=startYard.x+startYard.w&&tractor.y>=startYard.y&&tractor.y<=startYard.y+startYard.h)offRoad=false;
    if(isOnCurvedGravelRoad(tractor.x,tractor.y))offRoad=false;
    if(isOnConstructionRoad(tractor.x,tractor.y))offRoad=false;
    if(isOnFlare(tractor.x,tractor.y,constructionSiteJunctionX,roadBaseY,-1))offRoad=false;
    if(tractor.x>=constructionSite.x&&tractor.x<=constructionSite.x+constructionSite.w&&tractor.y>=constructionSite.y&&tractor.y<=constructionSite.y+constructionSite.h)offRoad=false;
    if(offRoad&&Math.abs(tractor.speed)>0.5)tractor.speed*=0.97;
    if(activeTrailer){const pX=tractor.x-Math.cos(tractor.angle)*101.25,pY=tractor.y-Math.sin(tractor.angle)*101.25;const dx=pX-activeTrailer.x,dy=pY-activeTrailer.y;activeTrailer.angle=Math.atan2(dy,dx);activeTrailer.x=pX-Math.cos(activeTrailer.angle)*(activeTrailer.w/2-33.75);activeTrailer.y=pY-Math.sin(activeTrailer.angle)*(activeTrailer.w/2-33.75);}
    updateForklift();updateGravelRoadHandles();camera.x=tractor.x;camera.y=tractor.y;
}
function startLevel3(){alert("Heading to Level 3!");}
canvas.addEventListener('pointerdown',(e)=>{if(!isEditMode)return;const wp=screenToWorld(e.clientX,e.clientY),mx=wp.x,my=wp.y;if(Math.sqrt((mx-gravelRoadHandles.center.x)**2+(my-gravelRoadHandles.center.y)**2)<150){activeEditTarget={type:'gravelCenter'};return;}if(Math.sqrt((mx-gravelRoadHandles.top.x)**2+(my-gravelRoadHandles.top.y)**2)<150){activeEditTarget={type:'gravelTop'};return;}if(Math.sqrt((mx-gravelRoadHandles.bottom.x)**2+(my-gravelRoadHandles.bottom.y)**2)<150){activeEditTarget={type:'gravelBottom'};return;}for(let tree of trees)if(Math.sqrt((mx-tree.x)**2+(my-tree.y)**2)<40){activeEditTarget=tree;return;}});
canvas.addEventListener('pointermove',(e)=>{if(!activeEditTarget||!isEditMode)return;const wp=screenToWorld(e.clientX,e.clientY),mx=wp.x,my=wp.y;if(activeEditTarget.type==='gravelCenter'){gravelRoadX=mx;updateStartYardPositions();rebuildStartYardStacks();rebuildStartYardCars();updateSpawnPosition();updateStartForkliftPosition();updateGravelRoadHandles();}else if(activeEditTarget.type==='gravelTop'){gravelRoadTopOffset=mx-gravelRoadX;updateGravelRoadHandles();}else if(activeEditTarget.type==='gravelBottom'){gravelRoadBottomOffset=mx-gravelRoadX;updateGravelRoadHandles();}else{activeEditTarget.x=mx;activeEditTarget.y=my;}});
canvas.addEventListener('pointerup',()=>activeEditTarget=null);
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(canvas.width/2,canvas.height/2);ctx.rotate(-tractor.angle-Math.PI/2);ctx.scale(currentZoom,currentZoom);ctx.translate(-camera.x,-camera.y);
    ctx.fillStyle="#2d613e";ctx.fillRect(-50000,-50000,100000,100000);
    trees.forEach(t=>drawTree(t));
    drawStartYardGround();drawOfficeSimple(startYard.x+50,startYard.y+300);
    startYardCars.forEach(c=>drawCar(c.x,c.y,c.color,-Math.PI/2));
    ctx.fillStyle="rgba(255,255,255,0.2)";ctx.fillRect(startYardLZone.x,startYardLZone.y,startYardLZone.w,startYardLZone.h);
    ctx.strokeStyle="#ffd700";ctx.setLineDash([20,10]);ctx.lineWidth=5;ctx.strokeRect(startYardLZone.x,startYardLZone.y,startYardLZone.w,startYardLZone.h);ctx.setLineDash([]);
    startYardStacks.forEach(s=>{if(s.exists)drawLumberLift(s.x,s.y,LUMBER_LAND_W,LUMBER_LAND_H);});
    drawForkliftL1(startForkliftX,startForkliftY,startForkliftAngle,startForkliftCarrying);
    drawFlare(gravelRoadX,roadBaseY,-1);drawFlare(constructionSiteJunctionX,roadBaseY,-1);drawFlare(siteLocationX,roadBaseY+roadWidth,+1);
    drawHorizRoad(-25000,25000,roadBaseY);drawCurvedGravelRoad(ctx);
    if(isEditMode){ctx.strokeStyle="rgba(0,255,255,0.3)";ctx.lineWidth=2;ctx.setLineDash([10,10]);ctx.beginPath();ctx.moveTo(gravelRoadHandles.center.x,gravelRoadHandles.center.y);ctx.lineTo(gravelRoadHandles.top.x,gravelRoadHandles.top.y);ctx.stroke();ctx.beginPath();ctx.moveTo(gravelRoadHandles.center.x,gravelRoadHandles.center.y);ctx.lineTo(gravelRoadHandles.bottom.x,gravelRoadHandles.bottom.y);ctx.stroke();ctx.setLineDash([]);drawEditHandle(gravelRoadHandles.center.x,gravelRoadHandles.center.y,"MID","#00ffff",50);drawEditHandle(gravelRoadHandles.top.x,gravelRoadHandles.top.y,"TOP","#ffff00",45);drawEditHandle(gravelRoadHandles.bottom.x,gravelRoadHandles.bottom.y,"BOT","#ff00ff",45);}
    drawConstructionSign(gravelRoadX+roadWidth/2+400,roadBaseY-500);
    drawVertRoad(constructionSiteJunctionX,roadBaseY-constructionRoadLength,roadBaseY);
    drawConstructionSign(constructionSiteJunctionX-300,roadBaseY-300);
    drawConstructionSiteGround();drawApartmentBuilding();
    materialPiles.forEach(p=>drawMaterialPile(constructionSite.x+p.x,constructionSite.y+p.y,p.type));
    csMachines.forEach(m=>{const wx=constructionSite.x+m.x,wy=constructionSite.y+m.y;switch(m.type){case 'excavator':drawExcavator(wx,wy,m.angle);break;case 'bulldozer':drawBulldozer(wx,wy,m.angle);break;case 'crane':drawCrane(wx,wy);break;case 'dumpTruck':drawDumpTruck(wx,wy,m.angle);break;}});
    csUnloadedLifts.forEach(l=>drawLumberLift(l.x-LUMBER_LAND_W/2,l.y-LUMBER_LAND_H/2,LUMBER_LAND_W,LUMBER_LAND_H));
    const lz=getCsLoadingZone();
    ctx.fillStyle="rgba(255,215,0,0.2)";ctx.fillRect(lz.x,lz.y,lz.w,lz.h);
    ctx.strokeStyle="#ffd700";ctx.lineWidth=6;ctx.setLineDash([20,10]);ctx.strokeRect(lz.x,lz.y,lz.w,lz.h);ctx.setLineDash([]);
    ctx.fillStyle="rgba(255,215,0,0.9)";ctx.font="bold 36px Arial";ctx.textAlign="center";
    ctx.fillText("UNLOAD",lz.x+lz.w/2,lz.y+lz.h/2-15);ctx.fillText("HERE",lz.x+lz.w/2,lz.y+lz.h/2+30);
    drawForkliftSprite(csForklift.x,csForklift.y,csForklift.angle,csForklift.carrying);
    drawVertRoad(siteLocationX,roadBaseY+roadWidth,roadBaseY+roadWidth+lumberRoadLength);
    drawLumberYardGround();drawRealisticOffice(remoteLumberYard.x+600,remoteLumberYard.y+remoteLumberYard.h-250,800,500);
    const carColors=["#cc0000","#333333","#ffffff","#0000aa","#555555"];const carW=67.5,carH=135;
    for(let i=0;i<5;i++){ctx.save();ctx.translate(remoteLumberYard.x+250+(i*135),remoteLumberYard.y+remoteLumberYard.h-600);ctx.fillStyle=carColors[i];ctx.fillRect(-carW/2,-carH/2,carW,carH);ctx.fillStyle="#000";ctx.fillRect(-carW/2-3,-carH/4,5,30);ctx.fillRect(carW/2-2,-carH/4,5,30);ctx.fillStyle="rgba(135,206,235,0.7)";ctx.fillRect(-carW/2+8,-carH/4,carW-16,25);ctx.restore();}
    ctx.fillStyle="rgba(255,255,255,0.15)";ctx.fillRect(loadingZone.x,loadingZone.y,loadingZone.w,loadingZone.h);
    lumberStacks.forEach(s=>{if(s.exists)drawLumberLift(s.x,s.y,s.w,s.h);});
    drawForkliftSprite(forklift.x,forklift.y,forklift.angle,forklift.carrying);
    drawTruckDetailed(tractor.x,tractor.y,tractor.angle,true);
    if(activeTrailer)drawTrailerStatic(activeTrailer.x,activeTrailer.y,activeTrailer.angle,activeTrailer.type);
    ctx.restore();
    drawCompass();
    update();
    requestAnimationFrame(draw);
}
startBtn.onclick=(e)=>{e.preventDefault();engineOn=!engineOn;timerStarted=true;startBtn.classList.toggle("on");startBtn.innerText=engineOn?"STOP":"START";};
document.getElementById("btnView").onclick=(e)=>{e.preventDefault();currentZoom=(currentZoom===0.35?0.15:0.35);};
const upBtn=document.getElementById("btnUp"),downBtn=document.getElementById("btnDown");
upBtn.addEventListener('pointerdown',(e)=>{e.preventDefault();touch.up=true;});upBtn.addEventListener('pointerup',(e)=>{e.preventDefault();touch.up=false;});
downBtn.addEventListener('pointerdown',(e)=>{e.preventDefault();touch.down=true;});downBtn.addEventListener('pointerup',(e)=>{e.preventDefault();touch.down=false;});
function processSteering(e){const rect=padEl.getBoundingClientRect();let si=(e.clientX-(rect.left+rect.width/2))/(rect.width/2);si=Math.max(-1,Math.min(1,si));tractor.steerAngle=si*0.6;wheelEl.style.transform=`translateX(${si*50}px)`;}
padEl.addEventListener('pointerdown',(e)=>{e.preventDefault();isSteeringActive=true;padEl.setPointerCapture(e.pointerId);processSteering(e);});
padEl.addEventListener('pointermove',(e)=>{if(padEl.hasPointerCapture(e.pointerId))processSteering(e);});
padEl.addEventListener('pointerup',(e)=>{e.preventDefault();isSteeringActive=false;wheelEl.style.transform=`translateX(0px)`;});
window.addEventListener('keydown',(e)=>{if(keys.hasOwnProperty(e.code))keys[e.code]=true;});
window.addEventListener('keyup',(e)=>{if(keys.hasOwnProperty(e.code))keys[e.code]=false;});
draw();
</script>
</body>
</html>