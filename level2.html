<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's Semi - Level 2 (4-Way Intersection)</title>
    <style>
        body { margin: 0; background: #2d613e; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; touch-action: none; height: 100vh; width: 100vw; -webkit-user-select: none; user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        #model-name { position: absolute; top: 5px; right: 10px; color: rgba(255,255,255,0.3); font-size: 10px; z-index: 20; }
        #dashboard { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; pointer-events: none; text-align: center; width: 100%; }
        #msg { font-size: 16px; color: #ffd700; text-shadow: 2px 2px #000; font-weight: bold; margin-bottom: 5px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 15px; display: inline-block; width: 94%; line-height: 1.2; box-sizing: border-box; border: 1px solid #444; transition: background 0.2s; }
        #gps-screen { position: absolute; bottom: 454px; left: 50%; transform: translateX(-50%); width: 90px; height: 30px; background: rgba(0, 0, 0, 0.8); border: 2px solid #ffd700; border-radius: 5px; color: #ffd700; font-family: 'Courier New', monospace; font-weight: bold; font-size: 14px; z-index: 20; pointer-events: none; display: flex; align-items: center; justify-content: center; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); line-height: 1.1; padding: 2px; box-sizing: border-box; }
        #msg.warning { background: rgba(200, 0, 0, 0.9); color: white; border: 2px solid #ff0000; }
        #msg.repair { background: rgba(255, 140, 0, 0.9); color: white; border: 2px solid #ffae00; }
        #bottom-stats { display: flex; justify-content: space-between; align-items: center; padding: 0 3%; margin-top: 5px; pointer-events: auto; }
        .stat-box { background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; border: 1px solid #444; font-family: monospace; font-size: 16px; pointer-events: none; }
        #btnBackToStart { width: 35px; height: 35px; border-radius: 50%; background: #ffd700; color: #000; font-weight: bold; font-size: 20px; border: 2px solid #000; display: flex; align-items: center; justify-content: center; pointer-events: auto; cursor: pointer; text-decoration: none; position: absolute; top: 0; left: 10px; }
        #controls { position: absolute; bottom: 15px; width: 100%; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .left-controls { display: flex; flex-direction: column; gap: 6px; align-items: flex-start; pointer-events: auto; }
        .pedal-box { display: flex; gap: 5px; }
        /* UPDATED: FIXED right to -20px to stay within trailer width constraints */
        #steering-pad { width: 160px; height: 60px; background: transparent; border-radius: 30px; position: absolute; right: -20px; bottom: 96px; touch-action: none; pointer-events: auto; display: flex; align-items: center; justify-content: center; }
        #steering-wheel { width: 30px; height: 30px; background: #000; border: none; border-radius: 50%; box-sizing: border-box; position: relative; transition: transform 0.1s linear; box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: none; }
        
        .btn { width: 55px; height: 48px; background: rgba(51,51,51,0.8); border: 2px solid #555; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; user-select: none; pointer-events: auto; }
        #btnStart { background: rgba(80,0,0,0.8); border-color: #f00; height: 32px; font-weight: bold; }
        #btnStart.on { background: rgba(0,80,0,0.8); border-color: #0f0; }
        #btnView { height: 32px; font-size: 8px; background: rgba(0, 100, 200, 0.8); }
        #btnSkip { height: 32px; font-size: 8px; background: rgba(128, 0, 128, 0.8); border-color: #a020f0; }
        #btnSave { height: 32px; font-size: 8px; background: rgba(0, 150, 0, 0.8); border-color: #0f0; }

        #victory-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); display: none; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 100; 
        }
        #victory-overlay h1 { color: #ffd700; font-size: 32px; margin-bottom: 20px; text-shadow: 0 0 10px #ffd700; text-align: center; }
        .continue-btn { padding: 15px 30px; font-size: 18px; background: #ffd700; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: black; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="model-name">Model: Gemini 3 Flash</div>

<div id="dashboard">
    <div id="msg">MISSION: DRIVE BACK TO THE YARD AND GET LOADED FOR THE NEXT CUSTOMER</div>
    <div id="bottom-stats">
        <div class="stat-box" style="color: #33ccff;">TIME: <span id="timer">00:00</span></div>
        <div class="stat-box" style="color: #ff3333;">DMG: <span id="damage">0%</span></div>
        <div class="stat-box" style="color: #ff9900;">DIST: <span id="miles">0.0</span></div>
        <a href="index.html" id="btnBackToStart">?</a>
    </div>
</div>

<div id="gps-screen">STRAIGHT</div>

<div id="victory-overlay">
    <h1 id="victory-msg">LOADED & READY!<br>LEVEL 2 COMPLETE</h1>
    <button class="continue-btn" onclick="startLevel3()">Head to Next Customer</button>
</div>

<canvas id="gameCanvas"></canvas>

<div id="controls">
    <div class="left-controls">
        <div class="pedal-box">
            <div id="btnDown" class="btn">REV</div>
            <div id="btnUp" class="btn">GAS</div>
        </div>
        <div style="display: flex; gap: 4px; margin-top: 4px;">
            <button id="btnStart" class="btn">START</button>
            <button id="btnView" class="btn">VIEW</button>
            <button id="btnSave" class="btn" onclick="toggleEditMode()">EDIT</button>
            <button id="btnDrop" class="btn" style="height:32px; font-size: 8px; background: rgba(200, 100, 0, 0.8);" onclick="handleHitch()">DROP/HOOK</button>
            <button id="btnSkip" class="btn" onclick="skipToGravel()">SKIP</button>
        </div>
    </div>
    <div id="steering-pad"><div id="steering-wheel"></div></div>
</div>

<script>
const roadBaseY = 850;
const siteLocationX = 4000; 
const roadWidth = 254; 
const lumberRoadLength = 1200;
const remoteLumberYard = { x: siteLocationX - 1625, y: roadBaseY + roadWidth + lumberRoadLength, w: 3250, h: 2000 };
const loadingZone = { x: remoteLumberYard.x + (remoteLumberYard.w/2) - (roadWidth/2), y: remoteLumberYard.y + (remoteLumberYard.h/2) - 400, w: roadWidth, h: 800 };

const gravelRoadX = siteLocationX - 8000; 
const gravelRoadLength = 2000;

let turnRadius = parseFloat(localStorage.getItem('remiSemi_turnRadius')) || 450; 
let isEditMode = false; 

const endYard = { x: gravelRoadX - 1200, y: -2800, w: 2400, h: 1800 }; 

let junctionHandleLeft = { x: gravelRoadX - roadWidth/2 - turnRadius, y: 0 }; 
let junctionHandleRight = { x: gravelRoadX + roadWidth/2 + turnRadius, y: 0 };
let activeEditTarget = null;

function skipToGravel() {
    tractor.x = siteLocationX;
    tractor.y = roadBaseY + roadWidth + 50;
    tractor.angle = Math.PI / 2;
    tractor.speed = 0;
    if (activeTrailer) {
        activeTrailer.angle = tractor.angle;
        activeTrailer.x = tractor.x - Math.cos(tractor.angle) * 440;
        activeTrailer.y = tractor.y - Math.sin(tractor.angle) * 440;
    }
}

function toggleEditMode() {
    const btn = document.getElementById("btnSave");
    const msgBox = document.getElementById("msg");
    if (!isEditMode) {
        isEditMode = true;
        btn.innerText = "SAVE";
        btn.style.background = "rgba(200, 0, 0, 0.8)";
        msgBox.innerText = "EDIT MODE: DRAG HANDLES ON ANY ITEM TO MOVE";
    } else {
        isEditMode = false;
        btn.innerText = "EDIT";
        btn.style.background = "rgba(0, 150, 0, 0.8)";
        localStorage.setItem('remiSemi_turnRadius', turnRadius);
        localStorage.setItem('remiSemi_trees', JSON.stringify(trees));
        localStorage.setItem('remiSemi_cars', JSON.stringify(parkedCars));
        localStorage.setItem('remiSemi_lumber', JSON.stringify(lumberStacks));
        msgBox.innerText = "LAYOUT SAVED!";
        setTimeout(() => { msgBox.innerText = "MISSION: DRIVE BACK TO THE YARD..."; }, 2000);
    }
}

let dustParticles = [];
function createDust(x, y) {
    if (Math.abs(tractor.speed) < 1) return;
    dustParticles.push({ x, y, size: 5 + Math.random() * 15, alpha: 0.6, life: 1.0 });
}

const carColors = ["#3498db", "#e74c3c", "#f1c40f", "#ecf0f1", "#95a5a6", "#1abc9c"];
let parkedCars = [
    { x: remoteLumberYard.x + 400, y: remoteLumberYard.y + 350, angle: 0, color: carColors[0] },
    { x: remoteLumberYard.x + 520, y: remoteLumberYard.y + 350, angle: 0, color: carColors[1] },
    { x: remoteLumberYard.x + 640, y: remoteLumberYard.y + 350, angle: 0, color: carColors[2] }
];

function getRoadY(x) {
    if (x > siteLocationX - 1200) return roadBaseY; 
    const targetY = roadBaseY + Math.sin(x / 1400) * 850;
    if (x > siteLocationX - 2500) {
        let weight = (x - (siteLocationX - 2500)) / 1300; 
        return (targetY * (1 - weight)) + (roadBaseY * weight);
    }
    return targetY;
}

let timeElapsed = 0, totalDistance = 0, gameActive = true, timerStarted = false;
let liftsLoaded = 0; 
let truckDamage = 0;
let accidents = 0;
let isRepairing = false;
let repairTimer = 0;
let offRoadTimer = 0;
let recoveryTimer = 0;
let gracePeriod = 0;

let serviceTruck = { x: 0, y: 0, angle: 0, active: false, flashState: false };

const savedLumber = localStorage.getItem('remiSemi_lumber');
let lumberStacks = savedLumber ? JSON.parse(savedLumber) : [];
if (lumberStacks.length === 0) {
    for(let i=0; i<12; i++) {
        for(let j=0; j<2; j++) {
            lumberStacks.push({ x: loadingZone.x - 210 - (j+1)*100, y: loadingZone.y - 220 + i*70, exists: true, side: 'left' });
            lumberStacks.push({ x: loadingZone.x + loadingZone.w + 110 + (j+1)*100, y: loadingZone.y - 220 + i*70, exists: true, side: 'right' });
        }
    }
}

let forklift = { 
    x: remoteLumberYard.x + 600, 
    y: remoteLumberYard.y + 600, 
    angle: Math.PI, 
    state: "idle", 
    carrying: false, 
    targetIdx: 0,
    side: "left"
};

const savedTrees = localStorage.getItem('remiSemi_trees');
let trees = savedTrees ? JSON.parse(savedTrees) : [];
if (trees.length === 0) {
    for(let i=0; i<100; i++) {
        let tx = (Math.random() - 0.5) * 15000 + 2000;
        let ty = (Math.random() - 0.5) * 10000 + 1000;
        let distToYard = Math.sqrt(Math.pow(tx - loadingZone.x, 2) + Math.pow(ty - loadingZone.y, 2));
        if (distToYard > 1000) {
            trees.push({ x: tx, y: ty, size: 40 + Math.random() * 30, rotation: Math.random() * Math.PI * 2 });
        }
    }
}

const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d");
const padEl = document.getElementById("steering-pad"), wheelEl = document.getElementById("steering-wheel"), startBtn = document.getElementById("btnStart");

let engineOn = false; const touch = { up: false, down: false }; let currentZoom = 0.35; 

const initialExitX = gravelRoadX;
const initialExitY = getRoadY(gravelRoadX) - roadWidth;
const tractor = { x: initialExitX, y: initialExitY, w: 292.5, h: 67.5, angle: Math.PI / 2, speed: 0, accel: 0.05, revAccel: 0.04, friction: 0.98, steerAngle: 0 };
const camera = { x: 0, y: 0 };

let allTrailers = [{ x: tractor.x, y: tractor.y - 440, w: 550, h: 92, angle: Math.PI / 2, type: 'flatbed' }];
let activeTrailer = allTrailers[0];
let isSteeringActive = false; 

const timerInterval = setInterval(() => { 
    if (!gameActive || !timerStarted) return; 
    timeElapsed++; 
    if (isRepairing) {
        repairTimer--;
        serviceTruck.flashState = !serviceTruck.flashState;
        if (repairTimer <= 0) {
            isRepairing = false;
            serviceTruck.active = false;
            truckDamage = Math.max(0, truckDamage - 30);
            document.getElementById("msg").classList.remove("repair");
            gracePeriod = 10; 
            startBtn.innerText = "START";
        }
    }
    if (recoveryTimer > 0) { recoveryTimer--; if (recoveryTimer <= 0) gracePeriod = 10; }
    if (gracePeriod > 0) gracePeriod--;
    const mins = Math.floor(timeElapsed / 60); 
    const secs = timeElapsed % 60; 
    document.getElementById("timer").innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; 
}, 1000);

function handleHitch() {
    if (activeTrailer) activeTrailer = null; 
    else allTrailers.forEach(t => { if (Math.sqrt(Math.pow(tractor.x - t.x, 2) + Math.pow(tractor.y - t.y, 2)) < 300) activeTrailer = t; });
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

function drawTree(t) { 
    ctx.save(); ctx.translate(t.x, t.y); ctx.rotate(t.rotation); ctx.fillStyle = "#1b4d2c"; ctx.beginPath(); ctx.arc(0, 0, t.size, 0, Math.PI*2); ctx.fill(); 
    if (isEditMode) { ctx.fillStyle = "rgba(255, 215, 0, 0.7)"; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill(); }
    ctx.restore(); 
}

function drawForklift(x, y, angle) { 
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle); 
    ctx.fillStyle = "#e67e22"; ctx.fillRect(-40, -25, 80, 50); 
    ctx.fillStyle = "#333"; ctx.fillRect(40, -22, 10, 44); 
    ctx.fillStyle = "#333"; ctx.fillRect(50, -20, 40, 5); 
    ctx.fillRect(50, 15, 40, 5);
    if (forklift.carrying) { ctx.fillStyle = "#d2b48c"; ctx.fillRect(55, -30, 60, 60); }
    ctx.fillStyle = "#111"; 
    ctx.fillRect(-35, -28, 20, 8); ctx.fillRect(-35, 20, 20, 8);
    ctx.fillRect(25, -28, 15, 8); ctx.fillRect(25, 20, 15, 8);
    ctx.restore(); 
}

function drawParkedCar(car) {
    ctx.save(); ctx.translate(car.x, car.y); ctx.rotate(car.angle);
    ctx.fillStyle = car.color; ctx.fillRect(-45, -22, 90, 44);
    ctx.fillStyle = "#111"; ctx.fillRect(-15, -18, 50, 36);
    if (isEditMode) { ctx.fillStyle = "rgba(255, 215, 0, 0.7)"; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill(); }
    ctx.restore();
}

function drawServiceTruck(x, y, angle, flashing) {
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
    ctx.fillStyle = "#eee"; ctx.fillRect(-60, -25, 120, 50); 
    ctx.fillStyle = "#333"; ctx.fillRect(20, -20, 35, 40); 
    ctx.fillStyle = "#111"; 
    ctx.fillRect(-45, -28, 25, 8); ctx.fillRect(-45, 20, 25, 8);
    ctx.fillRect(30, -28, 25, 8); ctx.fillRect(30, 20, 25, 8);
    if (flashing) { ctx.fillStyle = "#ffcc00"; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill(); }
    ctx.fillStyle = "#ff8800"; ctx.fillRect(-5, -5, 10, 10); 
    ctx.restore();
}

function drawOffice(x, y) {
    ctx.save(); ctx.translate(x, y);
    ctx.fillStyle = "#8d6e63"; ctx.fillRect(0, 0, 400, 250); 
    ctx.fillStyle = "#5d4037"; ctx.fillRect(-10, -10, 420, 20); 
    ctx.fillStyle = "#add8e6"; ctx.fillRect(50, 80, 80, 60); 
    ctx.fillRect(270, 80, 80, 60); 
    ctx.fillStyle = "#3e2723"; ctx.fillRect(170, 150, 60, 100); 
    ctx.fillStyle = "#fff"; ctx.font = "bold 24px Arial"; ctx.fillText("OFFICE", 155, 50);
    ctx.restore();
}

function drawLumberYardGround() {
    ctx.save();
    ctx.translate(remoteLumberYard.x, remoteLumberYard.y);
    ctx.fillStyle = "#555";
    ctx.fillRect(0, 0, remoteLumberYard.w, remoteLumberYard.h);
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 10;
    ctx.strokeRect(0, 0, remoteLumberYard.w, remoteLumberYard.h);
    ctx.strokeStyle = "#ffd700";
    ctx.lineWidth = 8;
    ctx.strokeRect(loadingZone.x - remoteLumberYard.x - 10, loadingZone.y - remoteLumberYard.y - 10, loadingZone.w + 20, loadingZone.h + 20);
    ctx.restore();
}

function drawConstructionSiteDetails() {
    ctx.save();
    ctx.translate(endYard.x, endYard.y);
    ctx.fillStyle = "#777"; ctx.fillRect(0, 0, endYard.w, endYard.h);
    const uzW = (roadWidth + 50) * 1.2;
    const uzH = 600 * 1.2;
    const uzX = 50;
    const uzY = 50;
    ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
    ctx.fillRect(uzX, uzY, uzW, uzH);
    ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 10; ctx.setLineDash([20,20]);
    ctx.strokeRect(uzX, uzY, uzW, uzH);
    ctx.setLineDash([]);
    ctx.restore();
}

function drawConstructionSign(x, y) {
    ctx.save(); ctx.translate(x, y);
    ctx.fillStyle = "#444"; ctx.fillRect(-5, 0, 10, 80);
    ctx.fillStyle = "#ff8800"; ctx.strokeStyle = "white"; ctx.lineWidth = 4;
    ctx.fillRect(-100, -60, 200, 80); ctx.strokeRect(-100, -60, 200, 80);
    ctx.fillStyle = "black"; ctx.font = "bold 18px Arial"; ctx.textAlign = "center";
    ctx.fillText("CONSTRUCTION", 0, -30); ctx.fillText("SITE", 0, -5);
    ctx.restore();
}

function drawTrailerStatic(x, y, angle, type) {
    const th = 92; 
    const tw = 550; 
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(-tw/2 + 5, -th/2 + 5, tw, th);
    for(let i = -th/2; i < th/2; i += 8) { ctx.fillStyle = (Math.floor(i/8) % 2 === 0) ? "#5d4037" : "#4a352f"; ctx.fillRect(-tw/2, i, tw, 8); }
    ctx.fillStyle = "#b0b0b0"; ctx.fillRect(-tw/2, -th/2, tw, 6); ctx.fillRect(-tw/2, th/2 - 6, tw, 6); 
    for(let i = -tw/2; i < tw/2; i += 20) { ctx.fillStyle = (Math.floor(i/20) % 2 === 0) ? "#d32f2f" : "#ffffff"; ctx.fillRect(i, -th/2 + 1, 10, 2); ctx.fillRect(i, th/2 - 3, 10, 2); }
    ctx.fillStyle = "#1a1a1a"; for(let i = -tw/2 + 15; i < tw/2; i += 40) { ctx.fillRect(i, -th/2, 8, 3); ctx.fillRect(i, th/2 - 3, 8, 3); }
    ctx.fillStyle = "#d2b48c"; for(let i=0; i<liftsLoaded; i++) { let side = (i < 6) ? 0 : 1; let row = (i < 6) ? i : (i - 6); ctx.fillRect(-tw/2 + 20 + row*80, (side === 0 ? -th/2 + 10 : th/2 - 40), 70, 30); }
    ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 3; for(let i = -tw/2 + 55; i < tw/2 - 50; i += 80) { ctx.beginPath(); ctx.moveTo(i, th/2 - 6); ctx.lineTo(i, -th/2 + 6); ctx.stroke(); }
    ctx.fillStyle = "#000"; ctx.fillRect(-tw/2 + 40, -th/2 - 5, 60, 10); ctx.fillRect(-tw/2 + 40, th/2 - 5, 60, 10);
    ctx.fillStyle = "#333"; ctx.fillRect(-tw/2, -th/2, 5, th); ctx.restore();
}

function drawTruckDetailed(x, y, angle, isSteering = false, cabColor = "#800000") {
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle); 
    if (gracePeriod > 0) ctx.globalAlpha = 0.6;
    const s = 2.25; 
    ctx.fillStyle = "#111"; ctx.fillRect((-130*s)/2, (-30*s)/6, (130*s) - (50*s), (30*s)/3); ctx.fillRect(0, (-30*s)/2, 60*s, 30*s); 
    ctx.fillStyle = "#000"; ctx.fillRect(-62*s, -12*s, 12*s, 6*s); ctx.fillRect(-62*s, 6*s, 12*s, 6*s); ctx.fillRect(-45*s, -12*s, 12*s, 6*s); ctx.fillRect(-45*s, 6*s, 12*s, 6*s); 
    ctx.save(); ctx.translate(46*s, (-30*s)/2 + 0.5); if(isSteering) ctx.rotate(tractor.steerAngle); ctx.fillRect(-6*s, -2.5*s, 12*s, 5*s); ctx.restore();
    ctx.save(); ctx.translate(46*s, (30*s)/2 - 0.5); if(isSteering) ctx.rotate(tractor.steerAngle); ctx.fillRect(-6*s, -2.5*s, 12*s, 5*s); ctx.restore();
    ctx.fillStyle = cabColor; ctx.fillRect(-10*s, (-30*s)/2, 40*s, 30*s); ctx.fillRect(30*s, (-30*s)/2 + 4*s, 30*s, (30*s) - 8*s); 
    ctx.fillStyle = "#aaa"; ctx.beginPath(); ctx.arc(-12*s, -18*s, 4*s, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-12*s, 18*s, 4*s, 0, Math.PI*2); ctx.fill(); 
    ctx.fillStyle = "#FFD700"; for(let i = 0; i < 4; i++) { let ly = (-30*s)/2 + 4*s + (i * 6.5 * s); ctx.fillRect(27*s, ly, 3*s, 3*s); }
    ctx.fillStyle = "#aaa"; ctx.fillRect(30*s, (-30*s)/2 - 4*s, 4*s, 5*s); ctx.fillRect(30*s, (30*s)/2 - 1*s, 4*s, 5*s);  
    ctx.restore();
}

function updateForklift() {
    if (liftsLoaded >= 12 || forklift.state === "idle") return;
    let targetX, targetY;
    const currentSafePoint = (forklift.side === "left") ? { x: activeTrailer.x - 400, y: activeTrailer.y - 180 } : { x: activeTrailer.x - 400, y: activeTrailer.y + 180 };
    if (forklift.state === "picking") {
        let stack = lumberStacks.find(s => s.exists && s.side === forklift.side) || lumberStacks.find(s => s.exists);
        targetX = stack.x + (forklift.side === 'left' ? 80 : -80); targetY = stack.y + 30;
        let dx = targetX - forklift.x, dy = targetY - forklift.y, dist = Math.sqrt(dx*dx + dy*dy); forklift.angle = Math.atan2(dy, dx);
        if (dist < 10) { forklift.carrying = true; stack.exists = false; forklift.state = "toSafePoint"; } 
        else { forklift.x += Math.cos(forklift.angle) * 12; forklift.y += Math.sin(forklift.angle) * 12; }
    } else if (forklift.state === "toSafePoint") {
        targetX = currentSafePoint.x; targetY = currentSafePoint.y;
        let dx = targetX - forklift.x, dy = targetY - forklift.y, dist = Math.sqrt(dx*dx + dy*dy); forklift.angle = Math.atan2(dy, dx);
        if (dist < 20) forklift.state = "delivering"; else { forklift.x += Math.cos(forklift.angle) * 15; forklift.y += Math.sin(forklift.angle) * 15; }
    } else if (forklift.state === "delivering") {
        let sideOffset = (forklift.side === "left") ? -80 : 80; let row = (liftsLoaded < 6) ? liftsLoaded : (liftsLoaded - 6);
        targetX = activeTrailer.x - 150 + (row * 65); targetY = activeTrailer.y + sideOffset;
        let dx = targetX - forklift.x, dy = targetY - forklift.y, dist = Math.sqrt(dx*dx + dy*dy); forklift.angle = Math.atan2(dy, dx);
        if (dist < 15) { forklift.carrying = false; liftsLoaded++; if (liftsLoaded === 6) { forklift.side = "right"; forklift.state = "toFrontBumper"; } else if (liftsLoaded === 12) { forklift.state = "idle"; handleLevelComplete(); } else { forklift.state = "picking"; } } 
        else { forklift.x += Math.cos(forklift.angle) * 15; forklift.y += Math.sin(forklift.angle) * 15; }
    } else if (forklift.state === "toFrontBumper") {
        targetX = tractor.x + 400; targetY = tractor.y - 150; 
        let dx = targetX - forklift.x, dy = targetY - forklift.y, dist = Math.sqrt(dx*dx + dy*dy); forklift.angle = Math.atan2(dy, dx);
        if (dist < 30) forklift.state = "circlingFront"; else { forklift.x += Math.cos(forklift.angle) * 15; forklift.y += Math.sin(forklift.angle) * 15; }
    } else if (forklift.state === "circlingFront") {
        targetX = tractor.x + 400; targetY = tractor.y + 250;
        let dx = targetX - forklift.x, dy = targetY - forklift.y, dist = Math.sqrt(dx*dx + dy*dy); forklift.angle = Math.atan2(dy, dx);
        if (dist < 30) forklift.state = "picking"; else { forklift.x += Math.cos(forklift.angle) * 15; forklift.y += Math.sin(forklift.angle) * 15; }
    }
}

function handleLevelComplete() {
    gameActive = false; document.getElementById("msg").innerText = "LOADED! MISSION SUCCESS!";
    setTimeout(() => {
        let playerName = prompt("LOAD COMPLETE! Enter your name for the Lumber Yard Records:", "Remi");
        if (playerName) { let finalTime = document.getElementById("timer").innerText; let finalDamage = document.getElementById("damage").innerText; document.getElementById("victory-msg").innerHTML = `SUCCESS, ${playerName.toUpperCase()}!<br>TIME: ${finalTime}<br>DAMAGE: ${finalDamage}<br>LEVEL 2 COMPLETE`; }
        document.getElementById("victory-overlay").style.display = "flex";
    }, 500);
}

function update() {
    if (!gameActive) return;
    if (isRepairing) { tractor.speed *= 0.8; let dx = (tractor.x - Math.cos(tractor.angle + 0.5) * 150) - serviceTruck.x; let dy = (tractor.y - Math.sin(tractor.angle + 0.5) * 150) - serviceTruck.y; serviceTruck.x += dx * 0.05; serviceTruck.y += dy * 0.05; return; }
    if (recoveryTimer > 0) { tractor.speed *= 0.8; return; }
    if (truckDamage >= 100) { engineOn = false; startBtn.classList.remove("on"); startBtn.innerText = "TOTALED"; }
    if (engineOn) { if (touch.up) tractor.speed += tractor.accel; if (touch.down) tractor.speed -= tractor.revAccel; }
    tractor.speed *= tractor.friction;
    if (!isSteeringActive) { tractor.steerAngle += (0 - tractor.steerAngle) * 0.12; if (Math.abs(tractor.steerAngle) < 0.001) tractor.steerAngle = 0; }
    let distToLumberYard = Math.sqrt(Math.pow(tractor.x - loadingZone.x, 2) + Math.pow(tractor.y - loadingZone.y, 2)) / 1000;
    document.getElementById("miles").innerText = distToLumberYard.toFixed(1);
    tractor.angle += (tractor.speed / 120) * Math.tan(tractor.steerAngle * 1.0); tractor.x += Math.cos(tractor.angle) * tractor.speed; tractor.y += Math.sin(tractor.angle) * tractor.speed;
    const gps = document.getElementById("gps-screen"); let mainY = getRoadY(gravelRoadX);
    if (tractor.x < gravelRoadX + 300 && tractor.y < mainY) { gps.innerText = "LEFT"; } else if (tractor.y < mainY && tractor.x > siteLocationX - 500) { gps.innerText = "RIGHT"; } else { gps.innerText = "STRAIGHT"; }
    let offRoad = true; let currentRoadY = getRoadY(tractor.x);
    if (tractor.y > currentRoadY && tractor.y < currentRoadY + roadWidth) offRoad = false;
    if (tractor.x > siteLocationX - roadWidth/2 && tractor.x < siteLocationX + roadWidth/2 && tractor.y > currentRoadY && tractor.y < currentRoadY + roadWidth + lumberRoadLength) offRoad = false;
    if (tractor.x > remoteLumberYard.x && tractor.x < remoteLumberYard.x + remoteLumberYard.w && tractor.y > remoteLumberYard.y && tractor.y < remoteLumberYard.y + remoteLumberYard.h) offRoad = false;
    if (tractor.x > endYard.x && tractor.x < endYard.x + endYard.w && tractor.y > endYard.y && tractor.y < endYard.y + endYard.h) offRoad = false;
    dustParticles.forEach((p, i) => { p.life -= 0.02; p.alpha -= 0.01; p.size += 0.5; if (p.life <= 0) dustParticles.splice(i, 1); });
    if (offRoad && Math.abs(tractor.speed) > 0.5) { truckDamage += 0.05; offRoadTimer++; if (gracePeriod <= 0) tractor.speed *= 0.95; } 
    if (gracePeriod <= 0) { trees.forEach(t => { let dx = tractor.x - t.x; let dy = tractor.y - t.y; let dist = Math.sqrt(dx*dx + dy*dy); if (dist < t.size + 30) { truckDamage += 5; accidents++; tractor.speed = -tractor.speed * 0.5; recoveryTimer = 10; } }); }
    document.getElementById("damage").innerText = Math.floor(Math.min(100, truckDamage)) + "%";
    if (activeTrailer) { const pX = tractor.x - Math.cos(tractor.angle) * 101.25, pY = tractor.y - Math.sin(tractor.angle) * 101.25, dx = pX - activeTrailer.x, dy = pY - activeTrailer.y; activeTrailer.angle = Math.atan2(dy, dx); activeTrailer.x = pX - Math.cos(activeTrailer.angle) * (activeTrailer.w / 2 - 33.75); activeTrailer.y = pY - Math.sin(activeTrailer.angle) * (activeTrailer.w / 2 - 33.75); }
    updateForklift(); camera.x = tractor.x; camera.y = tractor.y;
}

function startLevel3() { alert("Transitioning to Level 3: The New Customer Route!"); }

canvas.addEventListener('pointerdown', (e) => {
    if (!isEditMode) return;
    let mx = (e.clientX - canvas.width / 2) / currentZoom + camera.x; let my = (e.clientY - canvas.height / 2) / currentZoom + camera.y;
    if (Math.sqrt((mx - junctionHandleLeft.x)**2 + (my - junctionHandleLeft.y)**2) < 80) { activeEditTarget = junctionHandleLeft; return; }
    if (Math.sqrt((mx - junctionHandleRight.x)**2 + (my - junctionHandleRight.y)**2) < 80) { activeEditTarget = junctionHandleRight; return; }
    for(let car of parkedCars) { if (Math.sqrt((mx - car.x)**2 + (my - car.y)**2) < 60) { activeEditTarget = car; return; } }
    for(let tree of trees) { if (Math.sqrt((mx - tree.x)**2 + (my - tree.y)**2) < 40) { activeEditTarget = tree; return; } }
});

canvas.addEventListener('pointermove', (e) => {
    if (!activeEditTarget || !isEditMode) return;
    let mx = (e.clientX - canvas.width / 2) / currentZoom + camera.x; let my = (e.clientY - canvas.height / 2) / currentZoom + camera.y;
    activeEditTarget.x = mx; activeEditTarget.y = my;
});

canvas.addEventListener('pointerup', () => activeEditTarget = null);

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height); 
    ctx.save(); ctx.translate(canvas.width / 2, canvas.height / 2); ctx.rotate(-tractor.angle - Math.PI/2); ctx.scale(currentZoom, currentZoom); ctx.translate(-camera.x, -camera.y);
    ctx.fillStyle = "#2d613e"; ctx.fillRect(-50000, -50000, 100000, 100000); 
    trees.forEach(t => drawTree(t)); let mainY = getRoadY(gravelRoadX); drawConstructionSiteDetails();
    ctx.fillStyle = "#555"; ctx.beginPath(); ctx.rect(gravelRoadX - roadWidth/2, mainY - gravelRoadLength, roadWidth, gravelRoadLength); ctx.fill();
    ctx.fillStyle = "#333"; ctx.beginPath();
    for (let x = -25000; x < 25000; x += 5) { let y = getRoadY(x); if (x === -25000) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
    for (let x = 25000; x >= -25000; x -= 5) { let y = getRoadY(x) + roadWidth; ctx.lineTo(x, y); }
    ctx.fill(); ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 6; ctx.setLineDash([40, 40]); ctx.beginPath();
    for (let x = -25000; x < 25000; x += 5) { let y = getRoadY(x) + roadWidth/2; if (x === -25000) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
    ctx.stroke(); ctx.setLineDash([]); ctx.fillStyle = "#333"; 
    ctx.fillRect(siteLocationX - roadWidth/2, getRoadY(siteLocationX) + roadWidth, roadWidth, lumberRoadLength);
    drawLumberYardGround(); drawOffice(remoteLumberYard.x + 300, remoteLumberYard.y + 100); parkedCars.forEach(car => drawParkedCar(car));
    ctx.fillStyle = "rgba(255, 255, 255, 0.15)"; ctx.fillRect(loadingZone.x, loadingZone.y, loadingZone.w, loadingZone.h);
    drawConstructionSign(gravelRoadX + roadWidth/2 + 400, mainY - 500); lumberStacks.forEach(s => { if(s.exists) { ctx.fillStyle = "#d2b48c"; ctx.fillRect(s.x, s.y, 30, 60); } });
    drawForklift(forklift.x, forklift.y, forklift.angle); drawTruckDetailed(tractor.x, tractor.y, tractor.angle, true);
    if (activeTrailer) drawTrailerStatic(activeTrailer.x, activeTrailer.y, activeTrailer.angle, activeTrailer.type);
    ctx.restore(); update(); requestAnimationFrame(draw);
}

startBtn.onclick = (e) => { 
    e.preventDefault(); if (truckDamage >= 100 || isRepairing || recoveryTimer > 0) return; 
    engineOn = !engineOn; timerStarted = true; startBtn.classList.toggle("on"); startBtn.innerText = engineOn ? "STOP" : "START"; 
    if (!engineOn) { 
        let checkX = activeTrailer ? activeTrailer.x : tractor.x, checkY = activeTrailer ? activeTrailer.y : tractor.y;
        if (checkX > loadingZone.x - 200 && checkX < loadingZone.x + loadingZone.w + 200 && checkY > loadingZone.y - 200 && checkY < loadingZone.y + loadingZone.h + 200 && liftsLoaded < 12 && forklift.state === "idle") { forklift.state = "picking"; document.getElementById("msg").innerText = "LOADING FOR NEXT CUSTOMER..."; }
    }
};

document.getElementById("btnView").onclick = (e) => { e.preventDefault(); currentZoom = (currentZoom === 0.35 ? 0.15 : 0.35); };
const upBtn = document.getElementById("btnUp"), downBtn = document.getElementById("btnDown");
upBtn.addEventListener('pointerdown', (e) => { e.preventDefault(); touch.up = true; }); upBtn.addEventListener('pointerup', (e) => { e.preventDefault(); touch.up = false; });
downBtn.addEventListener('pointerdown', (e) => { e.preventDefault(); touch.down = true; }); downBtn.addEventListener('pointerup', (e) => { e.preventDefault(); touch.down = false; });
function processSteering(e) { const rect = padEl.getBoundingClientRect(); let sInput = (e.clientX - (rect.left + rect.width / 2)) / (rect.width / 2); sInput = Math.max(-1, Math.min(1, sInput)); tractor.steerAngle = sInput * 0.8; wheelEl.style.transform = `translateX(${sInput * 50}px)`; }
padEl.addEventListener('pointerdown', (e) => { e.preventDefault(); isSteeringActive = true; padEl.setPointerCapture(e.pointerId); processSteering(e); });
padEl.addEventListener('pointermove', (e) => { if (padEl.hasPointerCapture(e.pointerId)) processSteering(e); });
padEl.addEventListener('pointerup', (e) => { e.preventDefault(); isSteeringActive = false; wheelEl.style.transform = `translateX(0px)`; });
draw();
</script>
</body>
</html>
