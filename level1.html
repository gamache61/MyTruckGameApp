<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remi's Semi - Level 1</title>
    <style>
        body { margin: 0; background: #2d613e; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; touch-action: none; height: 100vh; width: 100vw; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        #gameCanvas { z-index: 1; }
        #sketchCanvas { z-index: 5; pointer-events: auto; position: absolute; top: 0; left: 0; }
        
        #dashboard { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; pointer-events: none; text-align: center; width: 100%; }
        #msg { font-size: 18px; color: #ffd700; text-shadow: 2px 2px #000; font-weight: bold; margin-bottom: 5px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 15px; display: inline-block; width: 94%; line-height: 1.2; box-sizing: border-box; border: 1px solid #444; }
        #bottom-stats { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .stat-box { background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; border: 1px solid #444; font-family: monospace; font-size: 16px; }
        #model-name { position: absolute; top: 5px; right: 10px; color: rgba(255,255,255,0.3); font-size: 10px; z-index: 10; }
        
        #debug-tools { position: absolute; top: 70px; right: 10px; z-index: 100; }
        .debug-btn { background: rgba(255,0,0,0.6); color: white; border: 1px solid white; padding: 5px 10px; font-size: 12px; cursor: pointer; border-radius: 4px; pointer-events: auto; }

        #btnHelp { position: absolute; top: 120px; left: 10px; z-index: 50; background: #ffd700; color: #000; border: none; width: 45px; height: 45px; border-radius: 50%; font-weight: bold; font-size: 24px; cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.5); pointer-events: auto; }
        
        #score-display { position: absolute; top: 120px; right: 10px; z-index: 20; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 8px; border: 1px solid #0f0; pointer-events: none; text-align: center; }
        #score-display label { display: block; font-size: 10px; color: #0f0; font-weight: bold; }

        #controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 40px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .left-controls { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; pointer-events: auto; }
        .pedal-box { display: flex; gap: 10px; }

        #steering-pad { width: 140px; aspect-ratio: 1 / 1; height: auto; background: rgba(255,255,255,0.1); border: 3px solid #555; border-radius: 50%; position: relative; touch-action: none; pointer-events: auto; margin-right: 20px; flex-shrink: 0; box-sizing: border-box; margin-bottom: 100px; }
        #steering-knob { width: 44px; height: 44px; background: #f00; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        
        .btn { width: 75px; height: 65px; background: rgba(51,51,51,0.8); border: 2px solid #555; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: white; user-select: none; pointer-events: auto; }
        #btnStart { background: rgba(80,0,0,0.8); border-color: #f00; width: 75px; height: 45px; font-weight: bold; font-size: 12px; }
        #btnStart.on { background: rgba(0,80,0,0.8); border-color: #0f0; }
        #btnDrop { background: rgba(200, 100, 0, 0.8); border-color: #ffaa00; font-weight: bold; width: 75px; height: 45px; font-size: 10px; }
        #action-box { display: flex; gap: 10px; margin-top: 5px; }
    </style>
</head>
<body onclick="unlockAudio()">

<div id="model-name">Model: Gemini 3 Flash</div>

<div id="debug-tools">
    <button class="debug-btn" onclick="skipToMissionEnd()">SKIP TO END OF M1</button>
</div>

<button id="btnHelp" onclick="window.location.href='index.html'">?</button>

<div id="score-display">
    <label>TIME</label>
    <div id="timeDisplay" class="ui-val">0.0s</div>
</div>

<canvas id="gameCanvas"></canvas>
<canvas id="sketchCanvas"></canvas>

<div id="dashboard">
    <div id="msg">YOUR TASK: DROP THE TRAILER IN THE MAIN YARD</div>
    <div id="bottom-stats">
        <div class="stat-box" style="color: #0f0;">TYPE: <span id="trailerType">BOX</span></div>
        <div class="stat-box" style="color: #ffd700;">ATTACHED: <span id="attachStatus">YES</span></div>
    </div>
</div>

<div id="controls">
    <div class="left-controls">
        <div class="pedal-box">
            <div class="btn" id="btnDown">REV</div>
            <div class="btn" id="btnUp">GAS</div>
        </div>
        <div id="action-box">
            <button id="btnStart" class="btn">START</button>
            <button id="btnDrop" class="btn">DROP/HOOK</button>
        </div>
    </div>
    <div id="steering-pad"><div id="steering-knob"></div></div>
</div>

<script>
if ('serviceWorker' in navigator) {
    const swContent = `
        const CACHE_NAME = 'remi-semi-v1';
        self.addEventListener('install', (e) => {
            e.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(['./'])));
        });
        self.addEventListener('fetch', (e) => {
            e.respondWith(caches.match(e.request).then((res) => res || fetch(e.request)));
        });
    `;
    const blob = new Blob([swContent], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).catch(err => console.log("SW failed", err));
}

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const sketchCanvas = document.getElementById("sketchCanvas");
const sketchCtx = sketchCanvas.getContext("2d");

const padEl = document.getElementById("steering-pad");
const knobEl = document.getElementById("steering-knob");
const startBtn = document.getElementById("btnStart");
const dropBtn = document.getElementById("btnDrop");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    sketchCanvas.width = window.innerWidth;
    sketchCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

let state = "DRIVING", engineOn = false, activeTrailer = null; 
let steerInput = 0; 
let showGrid = false; 
let isEditMode = false; 
let draggedObj = null; 
let draggedPoint = null; 
let audioCtx, engineOsc, engineGain, reverseOsc, reverseGain, lfo, lfoGain;
const camera = { x: 0, y: 0 };
let powerLevel = 2.0;
let levelTimer = 0;
let levelComplete = false;
let score = 0;
let timeBonus = 500;

function skipToMissionEnd() {
    let flatdeck = allTrailers.find(t => t.type === 'flatdeck');
    if (flatdeck) {
        tractor.x = loadingZone.x + loadingZone.w/2;
        tractor.y = loadingZone.y + loadingZone.h/2;
        tractor.angle = 0;
        flatdeck.x = tractor.x - 30;
        flatdeck.y = tractor.y;
        flatdeck.angle = 0;
        flatdeck.loadProgress = 4;
        flatdeck.hasLoad = true;
        activeTrailer = flatdeck;
        document.getElementById('attachStatus').innerText = "YES";
        document.getElementById('trailerType').innerText = "FLATDECK";
        levelComplete = true;
        score = 1000 + Math.floor(timeBonus);
        let playerName = prompt("MISSION COMPLETE! ENTER YOUR NAME:", "Driver") || "Driver";
        saveScore(playerName, score, levelTimer);
        document.getElementById('msg').innerText = playerName + " FINISHED! TIME: " + levelTimer.toFixed(1) + "s EARNED: $" + score;
        document.getElementById('msg').style.color = "#0f0";
    }
}

let drivewayPoints = JSON.parse(localStorage.getItem("remiDrivewayPoints")) || [
    {x: 3500, y: 850}, {x: 3500, y: 700}, {x: 3900, y: 700}, {x: 3900, y: 850}, 
    {x: 4800, y: 850}, {x: 5000, y: 595}, {x: 5400, y: 595}, {x: 5600, y: 850} 
];

let mainYardDriveway = JSON.parse(localStorage.getItem("remiMainDriveway")) || [
    {x: 600, y: 850}, {x: 750, y: 600}, {x: 950, y: 600}, {x: 1100, y: 850}
];

let mission2Road = [
    {x: 5600, y: 850}, {x: 6000, y: 850}, {x: 6300, y: 1100}, {x: 6800, y: 1100},
    {x: 7100, y: 850}, {x: 7500, y: 850}, {x: 7800, y: 600}, {x: 8200, y: 600}
];
let deliveryDriveway = [
    {x: 8200, y: 600}, {x: 8350, y: 400}, {x: 8550, y: 400}, {x: 8700, y: 600}
];

function saveScore(name, earnings, time) {
    let scores = JSON.parse(localStorage.getItem("remiSemiScores") || "[]");
    scores.push({ name, earnings, time: time.toFixed(1), date: new Date().toLocaleDateString() });
    scores.sort((a, b) => b.earnings - a.earnings);
    localStorage.setItem("remiSemiScores", JSON.stringify(scores.slice(0, 10)));
}

function unlockAudio() {
    if (!audioCtx) initAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    engineOsc = audioCtx.createOscillator(); engineOsc.type = 'sawtooth'; engineOsc.frequency.setValueAtTime(30, audioCtx.currentTime);
    engineGain = audioCtx.createGain(); engineGain.gain.setValueAtTime(0, audioCtx.currentTime);
    lfo = audioCtx.createOscillator(); lfo.type = 'sine'; lfo.frequency.setValueAtTime(6, audioCtx.currentTime); 
    lfoGain = audioCtx.createGain(); lfoGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    const filter = audioCtx.createBiquadFilter(); filter.type = "lowpass"; filter.frequency.value = 100; 
    lfo.connect(lfoGain); lfoGain.connect(engineGain.gain); 
    engineOsc.connect(filter); filter.connect(engineGain); engineGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1); 
    engineGain.connect(audioCtx.destination);
    engineOsc.start(); lfo.start();
    reverseOsc = audioCtx.createOscillator(); reverseGain = audioCtx.createGain();
    reverseOsc.type = 'sine'; reverseOsc.frequency.setValueAtTime(1000, audioCtx.currentTime);
    reverseGain.gain.setValueAtTime(0, audioCtx.currentTime);
    reverseOsc.connect(reverseGain); reverseGain.connect(audioCtx.destination); reverseOsc.start();
}

startBtn.onclick = () => { unlockAudio(); engineOn = !engineOn; startBtn.classList.toggle("on", engineOn); startBtn.innerText = engineOn ? "STOP" : "START"; state = engineOn ? "DRIVING" : "IDLE"; if(audioCtx) engineGain.gain.setTargetAtTime(engineOn ? 0.6 : 0, audioCtx.currentTime, 0.1); };
dropBtn.onclick = () => { toggleTrailer(); };

function toggleTrailer() {
    if (activeTrailer) { activeTrailer = null; document.getElementById('attachStatus').innerText = "NO"; } 
    else {
        let fWX = tractor.x - Math.cos(tractor.angle) * (tractor.w * 0.45); 
        let fWY = tractor.y - Math.sin(tractor.angle) * (tractor.w * 0.45);
        let found = null;
        allTrailers.forEach(t => {
            if (Math.hypot(fWX - (t.x + Math.cos(t.angle)*(t.w*0.1)), fWY - (t.y + Math.sin(t.angle)*(t.w*0.1))) < 130) found = t;
        });
        if (found) { activeTrailer = found; document.getElementById('attachStatus').innerText = "YES"; document.getElementById('trailerType').innerText = activeTrailer.type.toUpperCase(); }
    }
}

const tractor = { x: 0, y: 925, w: 274, h: 64, angle: 0, speed: 0, accel: 0.18, revAccel: 0.1, friction: 0.94, steerAngle: 0 };

let allTrailers = JSON.parse(localStorage.getItem("remiTrailers")) || [
    { x: -148, y: 925, w: 254, h: 68, angle: 0, type: 'box', hasLoad: false, loadProgress: 0, pivotDist: 127 },
    { x: 1050, y: 180, w: 254, h: 68, angle: Math.PI/2, type: 'box', hasLoad: false, loadProgress: 0, pivotDist: 127 },
    { x: 1150, y: 180, w: 254, h: 68, angle: Math.PI/2, type: 'box', hasLoad: false, loadProgress: 0, pivotDist: 127 },
    { x: 1250, y: 180, w: 254, h: 68, angle: Math.PI/2, type: 'flatdeck', hasLoad: false, loadProgress: 0, pivotDist: 127 },
    { x: 1350, y: 180, w: 254, h: 68, angle: Math.PI/2, type: 'flatdeck', hasLoad: false, loadProgress: 0, pivotDist: 127 }
];

allTrailers[0].angle = 0;
allTrailers[0].x = tractor.x - 148;
allTrailers[0].y = tractor.y;
activeTrailer = allTrailers[0];

const yard = { x: 50, y: 50, w: 1400, h: 550 }; 
const roadY = 850;
const lumberYard = { x: 3500, y: 50, w: 1600, h: 700 };
const deliveryYard = { x: 8000, y: 50, w: 800, h: 400 };

const savedZone = JSON.parse(localStorage.getItem("remiLoadingZone"));
const loadingZone = { 
    x: savedZone ? savedZone.x : 4110, 
    y: savedZone ? savedZone.y : 345, 
    w: 400, 
    h: 200, 
    dragging: false 
};

let woodStacks = JSON.parse(localStorage.getItem("remiWood")) || [];
if (woodStacks.length === 0) {
    for(let i=0; i<40; i++) { if (Math.floor(i/8) !== 2 && Math.floor(i/8) !== 3) woodStacks.push({ x: lumberYard.x + 400 + (i%8)*100, y: lumberYard.y + 100 + Math.floor(i/8)*120, w: 60, h: 40 }); }
}
const forklifts = [{ x: lumberYard.x + 200, y: lumberYard.y + 200, targetX: 0, targetY: 0, state: 'IDLE', speed: 2.2 }];

const parkedCars = [
    { x: yard.x + 400, y: yard.y + 175, color: "#3498db" }, 
    { x: yard.x + 440, y: yard.y + 175, color: "#e74c3c" }, 
    { x: yard.x + 480, y: yard.y + 175, color: "#f1c40f" }, 
    { x: lumberYard.x + 1400, y: lumberYard.y + 550, color: "#3498db" }
];

const environment = {
    trees: [],
    houses: []
};

for (let i = 0; i < 60; i++) {
    let tx = -2000 + (i * 350) + (Math.random() * 100);
    let ty = 840 + (Math.random > 0.5 ? 280 : -250);
    if ((tx > yard.x - 100 && tx < yard.x + yard.w + 100 && ty < yard.y + yard.h + 100) || 
        (tx > lumberYard.x - 100 && tx < lumberYard.x + lumberYard.w + 100 && ty < lumberYard.y + lumberYard.h + 100)) {
        continue; 
    }
    environment.trees.push({ x: tx, y: ty, size: 35 + (Math.random() * 25) });
}

const houseColors = ["#a52a2a", "#5f9ea0", "#deb887", "#708090", "#8e44ad", "#2c3e50"];
for (let i = 0; i < 15; i++) {
    let hx = 1200 + (i * 600);
    let hy = 840 + (Math.random() > 0.5 ? 400 : -450);
    if (hx > yard.x - 200 && hx < yard.x + yard.w + 200 && hy < yard.y + yard.h + 200) continue;
    if (hx > lumberYard.x - 200 && hx < lumberYard.x + lumberYard.w + 200 && hy < lumberYard.y + lumberYard.h + 200) continue;
    environment.houses.push({ x: hx, y: hy, color: houseColors[i % houseColors.length], w: 120, h: 100 });
}

const touch = { up: false, down: false, left: false, right: false };
let steeringTouchId = null;

window.onkeydown = (e) => {
    if(e.key === "w" || e.key === "ArrowUp") touch.up = true; if(e.key === "s" || e.key === "ArrowDown") touch.down = true;
    if(e.key === "a" || e.key === "ArrowLeft") touch.left = true; if(e.key === "d" || e.key === "ArrowRight") touch.right = true;
    if(e.key.toLowerCase() === "k") toggleTrailer();
    if(e.key.toLowerCase() === "g") showGrid = !showGrid;
    if(e.key.toLowerCase() === "e") { 
        isEditMode = !isEditMode; 
        if(!isEditMode) {
            localStorage.setItem("remiTrailers", JSON.stringify(allTrailers));
            localStorage.setItem("remiWood", JSON.stringify(woodStacks));
            localStorage.setItem("remiDrivewayPoints", JSON.stringify(drivewayPoints));
            localStorage.setItem("remiMainDriveway", JSON.stringify(mainYardDriveway));
            localStorage.setItem("remiLoadingZone", JSON.stringify({x: loadingZone.x, y: loadingZone.y}));
            alert("Layout Saved!");
        }
    }
};

canvas.onmousedown = (e) => {
    if(!isEditMode) return;
    const mx = (e.clientX / 0.45) + camera.x; const my = (e.clientY / 0.45) + camera.y;
    drivewayPoints.forEach(p => { if(Math.hypot(mx-p.x, my-p.y) < 25) draggedPoint = p; });
    mainYardDriveway.forEach(p => { if(Math.hypot(mx-p.x, my-p.y) < 25) draggedPoint = p; });
    if(draggedPoint) return;
    allTrailers.forEach(t => { if(Math.hypot(mx-t.x, my-t.y) < 50) draggedObj = t; });
    woodStacks.forEach(s => { if(mx > s.x && mx < s.x+s.w && my > s.y && my < s.y+s.h) draggedObj = s; });
};

function getTouchWorldPos(e) {
    const t = e.touches[0];
    return { x: (t.clientX / 0.45) + camera.x, y: (t.clientY / 0.45) + camera.y };
}

sketchCanvas.addEventListener("touchstart", (e) => {
    if(!isEditMode) return;
    const pos = getTouchWorldPos(e);
    if (Math.hypot(pos.x - loadingZone.x, pos.y - loadingZone.y) < 80) {
        loadingZone.dragging = true;
    }
});
sketchCanvas.addEventListener("touchmove", (e) => {
    if(isEditMode && loadingZone.dragging) {
        const pos = getTouchWorldPos(e);
        loadingZone.x = pos.x;
        loadingZone.y = pos.y;
    }
});
sketchCanvas.addEventListener("touchend", () => { loadingZone.dragging = false; });

canvas.onmousemove = (e) => {
    const mx = (e.clientX / 0.45) + camera.x; const my = (e.clientY / 0.45) + camera.y;
    if(isEditMode && draggedPoint) { draggedPoint.x = mx; draggedPoint.y = my; }
    else if(isEditMode && draggedObj) { draggedObj.x = mx - (draggedObj.w ? draggedObj.w/2 : 0); draggedObj.y = my - (draggedObj.h ? draggedObj.h/2 : 0); }
};
canvas.onmouseup = () => { draggedObj = null; draggedPoint = null; };

window.onkeyup = (e) => { if(e.key === "w" || e.key === "ArrowUp") touch.up = false; if(e.key === "s" || e.key === "ArrowDown") touch.down = false; if(e.key === "a" || e.key === "ArrowLeft") touch.left = false; if(e.key === "d" || e.key === "ArrowRight") touch.right = false; };

padEl.addEventListener("touchstart", (e) => { e.preventDefault(); steeringTouchId = e.changedTouches[0].identifier; updateSteerFromTouch(e.changedTouches[0]); });
padEl.addEventListener("touchmove", (e) => { e.preventDefault(); for (let i = 0; i < e.changedTouches.length; i++) if (e.changedTouches[i].identifier === steeringTouchId) updateSteerFromTouch(e.changedTouches[i]); });
padEl.addEventListener("touchend", () => { steeringTouchId = null; steerInput = 0; knobEl.style.left = "50%"; });

function updateSteerFromTouch(t) { const rect = padEl.getBoundingClientRect(); steerInput = Math.max(-1, Math.min(1, (t.clientX - (rect.left + rect.width/2)) / (rect.width/2))); if(Math.abs(steerInput) < 0.1) steerInput = 0; knobEl.style.left = (50 + steerInput * 40) + "%"; }
const setupBtn = (id, key) => { const el = document.getElementById(id); el.addEventListener("touchstart", (e) => { e.preventDefault(); touch[key] = true; }); el.addEventListener("touchend", (e) => { e.preventDefault(); touch[key] = false; }); };
setupBtn("btnUp", "up"); setupBtn("btnDown", "down");

function update() {
    if (isEditMode) return;
    if(touch.left) steerInput = -1; else if(touch.right) steerInput = 1; else if(steeringTouchId === null) steerInput = 0;
    
    tractor.steerAngle += (steerInput * 0.52 - tractor.steerAngle) * 0.35; 
    
    if (engineOn && !levelComplete) {
        levelTimer += 1/60; 
        document.getElementById('timeDisplay').innerText = levelTimer.toFixed(1) + "s"; 
        if (timeBonus > 0) timeBonus -= 0.05;

        if (touch.up) tractor.speed += (tractor.accel * (powerLevel / 2)); 
        if (touch.down) tractor.speed -= (tractor.revAccel * 0.8); 
        if (audioCtx) {
            let baseFreq = 30 + (powerLevel * 5); 
            let speedPitch = Math.abs(tractor.speed) * 15;
            engineOsc.frequency.setTargetAtTime(baseFreq + speedPitch, audioCtx.currentTime, 0.1);
            lfo.frequency.setTargetAtTime(6 + (Math.abs(tractor.speed) * 2), audioCtx.currentTime, 0.1);
            engineGain.gain.setTargetAtTime(0.4 + (Math.abs(tractor.speed) * 0.05), audioCtx.currentTime, 0.1);
        }
    } else if (audioCtx && engineOn) {
        engineOsc.frequency.setTargetAtTime(30 + (powerLevel * 5), audioCtx.currentTime, 0.2);
    }
    
    tractor.speed *= tractor.friction;
    tractor.angle += (tractor.speed / 45) * Math.tan(tractor.steerAngle);
    tractor.x += Math.cos(tractor.angle) * tractor.speed; 
    tractor.y += Math.sin(tractor.angle) * tractor.speed;
    
    if (activeTrailer) { 
        const pivotX = tractor.x - Math.cos(tractor.angle) * (tractor.w * 0.35); 
        const pivotY = tractor.y - Math.sin(tractor.angle) * (tractor.w * 0.35);
        
        const dx = pivotX - activeTrailer.x;
        const dy = pivotY - activeTrailer.y;
        activeTrailer.angle = Math.atan2(dy, dx);
        
        activeTrailer.x = pivotX - Math.cos(activeTrailer.angle) * (activeTrailer.w / 2 - (activeTrailer.w * 0.12));
        activeTrailer.y = pivotY - Math.sin(activeTrailer.angle) * (activeTrailer.w / 2 - (activeTrailer.w * 0.12));
    }

    if (!levelComplete) { 
        document.getElementById('msg').style.color = "#ffd700"; 
        if (activeTrailer && activeTrailer.type === 'box') {
            document.getElementById('msg').innerText = "YOUR TASK: DROP THE TRAILER IN THE MAIN YARD";
        } else if (!activeTrailer) {
            document.getElementById('msg').innerText = "YOUR TASK: HOOK THE FLATDECK TRAILER USING [K]";
        } else if (activeTrailer.type === 'flatdeck' && !activeTrailer.hasLoad) {
            document.getElementById('msg').innerText = "YOUR TASK: DRIVE TO LUMBER YARD LOADING ZONE";
        }
    }
    let fl = forklifts[0]; 
    let trailerInZone = activeTrailer && (activeTrailer.x > loadingZone.x && activeTrailer.x < loadingZone.x + loadingZone.w && activeTrailer.y > loadingZone.y && activeTrailer.y < loadingZone.y + loadingZone.h);
    if (trailerInZone && activeTrailer.type === 'flatdeck' && !activeTrailer.hasLoad && Math.abs(tractor.speed) < 0.25 && fl.state === 'IDLE') { fl.state = 'LOADING'; fl.targetX = activeTrailer.x; fl.targetY = activeTrailer.y; }
    if (fl.state === 'LOADING' || fl.state === 'RETURNING') { let dx = fl.targetX - fl.x; let dy = fl.targetY - fl.y; let dist = Math.hypot(dx, dy); if (dist > 5) { fl.x += (dx/dist) * fl.speed; fl.y += (dy/dist) * fl.speed; } else if (fl.state === 'LOADING') { activeTrailer.loadProgress += 1; if(activeTrailer.loadProgress >= 4) { activeTrailer.hasLoad = true; levelComplete = true; score = 1000 + Math.floor(timeBonus); playerName = prompt("MISSION COMPLETE! ENTER YOUR NAME:", "Driver") || "Driver"; saveScore(playerName, score, levelTimer); document.getElementById('msg').innerText = playerName + " FINISHED! TIME: " + levelTimer.toFixed(1) + "s EARNED: $" + score; document.getElementById('msg').style.color = "#0f0"; } fl.state = 'RETURNING'; fl.targetX = lumberYard.x + 200; fl.targetY = lumberYard.y + 200; } else fl.state = 'IDLE'; }
    camera.x = tractor.x - (canvas.width / 0.45) / 2;
    camera.y = tractor.y - (canvas.height / 0.45) / 2;
}

function drawTrailer(t) { 
    ctx.save();
    ctx.translate(t.x, t.y);
    ctx.rotate(t.angle);
    
    if(t.type === 'box') {
        ctx.fillStyle = "#fff"; 
        ctx.fillRect(-t.w/2, -t.h/2, t.w, t.h);
        ctx.strokeStyle = "#bbb";
        ctx.lineWidth = 2;
        ctx.strokeRect(-t.w/2, -t.h/2, t.w, t.h);
        ctx.beginPath();
        for(let i=-t.w/2 + 20; i < t.w/2; i+=40) {
            ctx.moveTo(i, -t.h/2); ctx.lineTo(i, t.h/2);
        }
        ctx.stroke();
    } else {
        ctx.fillStyle = "#5e442a"; 
        ctx.fillRect(-t.w/2, -t.h/2, t.w, t.h);
        ctx.strokeStyle = "#111";
        ctx.lineWidth = 4;
        ctx.strokeRect(-t.w/2, -t.h/2, t.w, t.h);
        ctx.strokeStyle = "#2a1a0a";
        ctx.lineWidth = 1;
        for(let i = -t.h/2 + 10; i < t.h/2; i+=10) {
            ctx.beginPath(); ctx.moveTo(-t.w/2, i); ctx.lineTo(t.w/2, i); ctx.stroke();
        }
        
        if(t.hasLoad) { 
            ctx.fillStyle = "#8B4513"; 
            ctx.fillRect(-t.w/2 + 42, -25, 170, 50); 
            ctx.strokeStyle = "#000"; ctx.lineWidth = 2; ctx.strokeRect(-t.w/2 + 42, -25, 170, 50);
        } else if(t.loadProgress > 0) { 
            ctx.fillStyle = "#8B4513"; 
            ctx.fillRect(-t.w/2 + 42, -25, 42 * t.loadProgress, 50); 
        }
    }
    
    ctx.fillStyle = "#111"; 
    ctx.fillRect(-t.w/2 + 10, t.h/2, 25, 6);
    ctx.fillRect(-t.w/2 + 10, -t.h/2 - 6, 25, 6);
    ctx.restore(); 
}

function drawDrivewayPoly(pts) { ctx.fillStyle = "#333"; ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); pts.forEach(p => ctx.lineTo(p.x, p.y)); ctx.closePath(); ctx.fill(); }

function drawWindyRoad(pts) {
    ctx.fillStyle = "#333";
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y - 127); 
    for(let i=1; i<pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y - 127);
    for(let i=pts.length-1; i>=0; i--) ctx.lineTo(pts[i].x, pts[i].y + 127);
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle = "#ffff00"; ctx.setLineDash([40, 40]); ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1; i<pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.stroke(); ctx.setLineDash([]);
}

function drawDirectionIndicator(x, y, angle) {
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle); ctx.fillStyle = "rgba(0, 255, 0, 0.6)"; ctx.beginPath(); ctx.moveTo(30, 0); ctx.lineTo(0, -15); ctx.lineTo(0, -7); ctx.lineTo(-20, -7); ctx.lineTo(-20, 7); ctx.lineTo(0, 7); ctx.lineTo(0, 15); ctx.closePath(); ctx.fill(); ctx.restore();
}

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    sketchCtx.clearRect(0,0, sketchCanvas.width, sketchCanvas.height);
    ctx.save(); ctx.scale(0.45, 0.45); ctx.translate(-camera.x, -camera.y);
    ctx.fillStyle = "#2d613e"; ctx.fillRect(-5000, -5000, 20000, 10000);
    ctx.fillStyle = "#333"; ctx.fillRect(-5000, roadY, 15000, 254);
    ctx.strokeStyle = "#ffff00"; ctx.setLineDash([40, 40]); ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(-5000, roadY + 127); ctx.lineTo(15000, roadY + 127); ctx.stroke(); ctx.setLineDash([]);
    
    drawWindyRoad(mission2Road);
    drawDrivewayPoly(deliveryDriveway);
    ctx.fillStyle = "#555"; ctx.fillRect(deliveryYard.x, deliveryYard.y, deliveryYard.w, deliveryYard.h);
    ctx.strokeStyle = "#888"; ctx.lineWidth = 4;
    ctx.strokeRect(deliveryYard.x, deliveryYard.y, deliveryYard.w, deliveryYard.h);
    ctx.fillStyle = "#222";
    ctx.fillRect(deliveryYard.x + 200, deliveryYard.y + 100, 400, 200); 
    ctx.fillStyle = "#ffd700"; ctx.font = "bold 24px Arial"; ctx.textAlign = "center";
    ctx.fillText("MISSION 2: DELIVERY POINT", deliveryYard.x + 400, deliveryYard.y + 150);

    drawDrivewayPoly(mainYardDriveway);
    drawDrivewayPoly([drivewayPoints[0], drivewayPoints[1], drivewayPoints[2], drivewayPoints[3]]);
    drawDrivewayPoly([drivewayPoints[4], drivewayPoints[5], drivewayPoints[6], drivewayPoints[7]]);
    ctx.fillStyle = "#555"; ctx.fillRect(yard.x, yard.y, yard.w, yard.h); ctx.strokeStyle = "#888"; ctx.lineWidth = 4; 
    ctx.beginPath(); ctx.moveTo(yard.x, yard.y); ctx.lineTo(yard.x + yard.w, yard.y); ctx.lineTo(yard.x + yard.w, yard.y + yard.h); ctx.lineTo(Math.max(mainYardDriveway[1].x, mainYardDriveway[2].x), yard.y + yard.h); ctx.moveTo(Math.min(mainYardDriveway[1].x, mainYardDriveway[2].x), yard.y + yard.h); ctx.lineTo(yard.x, yard.y + yard.h); ctx.lineTo(yard.x, yard.y); ctx.stroke();
    
    ctx.fillStyle = "#222"; ctx.fillRect(mainYardDriveway[0].x - 100, mainYardDriveway[0].y - 50, 160, 40); ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 2; ctx.strokeRect(mainYardDriveway[0].x - 100, mainYardDriveway[0].y - 50, 160, 40); ctx.fillStyle = "#ffd700"; ctx.font = "bold 20px Arial"; ctx.textAlign = "center"; ctx.fillText("MAIN YARD", mainYardDriveway[0].x - 20, mainYardDriveway[0].y - 23);
    
    /* UPDATED: Added real Loading Doors to the Main Yard Warehouse */
    ctx.fillStyle = "#777"; 
    ctx.fillRect(yard.x + 20, yard.y + 20, 350, 180); 
    ctx.fillStyle = "#222";
    ctx.fillRect(yard.x + 50, yard.y + 180, 80, 20); // Door 1
    ctx.fillRect(yard.x + 150, yard.y + 180, 80, 20); // Door 2
    ctx.strokeStyle = "#444";
    ctx.lineWidth = 2;
    ctx.strokeRect(yard.x + 50, yard.y + 180, 80, 20);
    ctx.strokeRect(yard.x + 150, yard.y + 180, 80, 20);
    
    ctx.fillStyle = "#d2b48c"; ctx.fillRect(yard.x + 370, yard.y + 20, 180, 100); 
    
    ctx.fillStyle = "#222"; ctx.fillRect(drivewayPoints[1].x - 280, 810, 200, 40); ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 2; ctx.strokeRect(drivewayPoints[1].x - 280, 810, 200, 40); ctx.fillStyle = "#ffd700"; ctx.font = "bold 22px Arial"; ctx.textAlign = "center"; ctx.fillText("LUMBER YARD", drivewayPoints[1].x - 180, 837);
    environment.houses.forEach(h => { ctx.save(); ctx.translate(h.x, h.y); ctx.fillStyle = h.color; ctx.fillRect(0, 0, h.w, h.h); ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.lineWidth = 2; ctx.strokeRect(0, 0, h.w, h.h); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(h.w/2, h.h/2); ctx.moveTo(h.w, 0); ctx.lineTo(h.w/2, h.h/2); ctx.moveTo(0, h.h); ctx.lineTo(h.w/2, h.h/2); ctx.moveTo(h.w, h.h); ctx.lineTo(h.w/2, h.h/2); ctx.stroke(); ctx.restore(); });
    environment.trees.forEach(t => { ctx.save(); ctx.translate(t.x, t.y); ctx.fillStyle = "#0b3d1b"; for(let i=0; i<4; i++) { ctx.beginPath(); let offX = Math.cos(i * Math.PI/2) * (t.size/4); let offY = Math.sin(i * Math.PI/2) * (t.size/4); ctx.arc(offX, offY, t.size/2, 0, Math.PI*2); ctx.fill(); } ctx.restore(); });
    ctx.fillStyle = "#4a4a4a"; ctx.fillRect(lumberYard.x, lumberYard.y, lumberYard.w, lumberYard.h); ctx.strokeStyle = "#888"; ctx.lineWidth = 4; 
    ctx.beginPath(); ctx.moveTo(lumberYard.x, lumberYard.y); ctx.lineTo(lumberYard.x + lumberYard.w, lumberYard.y); ctx.lineTo(lumberYard.x + lumberYard.w, lumberYard.y + lumberYard.h); ctx.lineTo(Math.max(drivewayPoints[5].x, drivewayPoints[6].x), lumberYard.y + lumberYard.h); ctx.moveTo(Math.min(drivewayPoints[5].x, drivewayPoints[6].x), lumberYard.y + lumberYard.h); ctx.lineTo(Math.max(drivewayPoints[1].x, drivewayPoints[2].x), lumberYard.y + lumberYard.h); ctx.moveTo(Math.min(drivewayPoints[1].x, drivewayPoints[2].x), lumberYard.y + lumberYard.h); ctx.lineTo(lumberYard.x, lumberYard.y + yard.h); ctx.lineTo(lumberYard.x, lumberYard.y); ctx.stroke();
    ctx.fillStyle = "#d2b48c"; ctx.fillRect(lumberYard.x + 1350, lumberYard.y + 50, 200, 120); ctx.fillStyle = "#333"; ctx.fillRect(lumberYard.x, lumberYard.y + 300, lumberYard.w, 150);
    woodStacks.forEach(s => { ctx.fillStyle = "#8B4513"; ctx.fillRect(s.x, s.y, s.w, s.h); }); 
    parkedCars.forEach(car => { ctx.fillStyle = car.color; ctx.fillRect(car.x, car.y, 12, 25); });
    forklifts.forEach(f => { ctx.fillStyle = "#ffa500"; ctx.fillRect(f.x - 10, f.y - 10, 20, 20); ctx.fillStyle = "#333"; ctx.fillRect(f.x + 5, f.y - 8, 15, 2); ctx.fillRect(f.x + 5, f.y + 6, 15, 2); });
    ctx.save(); ctx.fillStyle = "rgba(255, 170, 0, 0.3)"; ctx.fillRect(loadingZone.x, loadingZone.y, loadingZone.w, loadingZone.h); ctx.strokeStyle = "#ffaa00"; ctx.lineWidth = 4; ctx.setLineDash([10, 5]); ctx.strokeRect(loadingZone.x, loadingZone.y, loadingZone.w, loadingZone.h); ctx.setLineDash([]); ctx.fillStyle = "#ffff00"; ctx.font = "bold 34px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("Loading Zone", loadingZone.x + (loadingZone.w / 2), loadingZone.y + (loadingZone.h / 2));
    if(isEditMode) { ctx.beginPath(); ctx.arc(loadingZone.x, loadingZone.y, 25, 0, Math.PI * 2); ctx.fill(); } ctx.restore();
    
    ctx.save();
    ctx.translate(tractor.x, tractor.y);
    ctx.rotate(tractor.angle);
    ctx.fillStyle = "#111";
    ctx.fillRect(-tractor.w/2, -tractor.h/6, tractor.w - 105, tractor.h/3); 
    ctx.fillRect(0, -tractor.h/2, 126, tractor.h); 
    ctx.fillStyle = "#000";
    ctx.fillRect(-131, -25, 25, 13); ctx.fillRect(-131, 13, 25, 13); 
    ctx.fillRect(-95, -25, 25, 13); ctx.fillRect(-95, 13, 25, 13); 
    ctx.fillRect(85, -tractor.h/2 - 4, 25, 11);
    ctx.fillRect(85, tractor.h/2 - 7, 25, 11); 
    ctx.fillStyle = "#800000";
    ctx.fillRect(-21, -tractor.h/2, 85, tractor.h); 
    ctx.fillRect(64, -tractor.h/2 + 8, 64, tractor.h - 17); 
    ctx.fillStyle = "#c0c0c0";
    ctx.fillRect(121, -2, 6, 4); 
    ctx.fillStyle = "#222"; 
    ctx.fillRect(55, -tractor.h/2 + 4, 8, tractor.h - 8); 
    ctx.fillRect(25, -tractor.h/2 + 2, 27, 4); 
    ctx.fillRect(25, tractor.h/2 - 6, 27, 4);  
    ctx.fillStyle = "#FFD700";
    ctx.shadowBlur = 8;
    ctx.shadowColor = "orange";
    for(let i = 0; i < 4; i++) {
        let ly = -tractor.h/2 + 8 + (i * 14); 
        ctx.fillRect(57, ly, 6, 6); 
    }
    ctx.shadowBlur = 0; 
    ctx.fillStyle = "#777";
    ctx.fillRect(-25, -tractor.h/2 - 6, 11, 11); 
    ctx.fillRect(-25, tractor.h/2 - 4, 11, 11);  
    ctx.fillStyle = "#aaa";
    ctx.fillRect(55, -tractor.h/2 - 6, 6, 8); 
    ctx.fillRect(55, tractor.h/2 - 2, 6, 8);  
    ctx.fillStyle = "#d1d1d1";
    ctx.fillRect(126, -tractor.h/2 + 13, 8, tractor.h - 25);
    ctx.restore();

    allTrailers.forEach(t => drawTrailer(t));

    if (activeTrailer && activeTrailer.type === 'box') { drawDirectionIndicator(200, 925, 0); drawDirectionIndicator(850, 925, 0); drawDirectionIndicator(850, 750, -Math.PI/2); 
    } else if (!activeTrailer) { drawDirectionIndicator(1500, 925, 0); drawDirectionIndicator(2200, 925, 0); drawDirectionIndicator(3700, 925, 0); drawDirectionIndicator(3700, 750, -Math.PI/2); 
    } else if (activeTrailer.type === 'flatdeck' && !activeTrailer.hasLoad) { drawDirectionIndicator(loadingZone.x + (loadingZone.w/2), loadingZone.y + (loadingZone.h/2), 0); }
    if(isEditMode) { drivewayPoints.forEach(p => { ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = "red"; ctx.stroke(); }); mainYardDriveway.forEach(p => { ctx.fillStyle = "yellow"; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = "orange"; ctx.stroke(); }); }
    if (showGrid) { ctx.strokeStyle = "rgba(255, 255, 255, 0.2)"; ctx.lineWidth = 1; for (let x = -5000; x <= 15000; x += 100) { ctx.beginPath(); ctx.moveTo(x, -5000); ctx.lineTo(x, 5000); ctx.stroke(); } for (let y = -5000; y <= 5000; y += 100) { ctx.beginPath(); ctx.moveTo(-5000, y); ctx.lineTo(15000, y); ctx.stroke(); } }
    ctx.restore(); requestAnimationFrame(() => { update(); draw(); });
}
draw();
</script>
</body>
</html>
